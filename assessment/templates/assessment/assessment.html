{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta property="og:title" content="14419088">
    <meta property="og:description" content="Ø¨Ø§ ØªØ³Øª Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ÛŒØ§Ø¨ÛŒ Ø´ØºÙ„ÛŒ Ù‡ÙˆØ´ Ù…Ù†Ø¯ Ú©Ø§ÙÙ†Ø§ØŒ Ù…Ø³ÛŒØ± Ø´ØºÙ„ÛŒ Ø§ÛŒØ¯Ù‡â€ŒØ¢Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ú©Ù…ØªØ± Ø§Ø² 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø´Ù Ú©Ù†ÛŒØ¯. ØªØ­Ù„ÛŒÙ„ Ø¯Ù‚ÛŒÙ‚ Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø´ØºÙ„ÛŒ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡.">
    <meta property="og:image" content="{% static 'icon.jpg' %}">
    <meta property="og:url" content="https://kafna.ir/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Ú©Ø§ÙÙ†Ø§ - ØªØ³Øª Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ÛŒØ§Ø¨ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯">
    <meta name="twitter:description" content="Ø¨Ø§ ØªØ³Øª Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ÛŒØ§Ø¨ÛŒ Ø´ØºÙ„ÛŒ Ù‡ÙˆØ´ Ù…Ù†Ø¯ Ú©Ø§ÙÙ†Ø§ØŒ Ù…Ø³ÛŒØ± Ø´ØºÙ„ÛŒ Ø§ÛŒØ¯Ù‡â€ŒØ¢Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ú©Ù…ØªØ± Ø§Ø² 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø´Ù Ú©Ù†ÛŒØ¯.">
    <title>Ú©Ø§ÙÙ†Ø§ - ØªØ³Øª Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ÛŒØ§Ø¨ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</title>
    <meta name="description" content="Ø¨Ø§ ØªØ³Øª Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ÛŒØ§Ø¨ÛŒ Ø´ØºÙ„ÛŒ Ù‡ÙˆØ´ Ù…Ù†Ø¯ Ú©Ø§ÙÙ†Ø§ØŒ Ù…Ø³ÛŒØ± Ø´ØºÙ„ÛŒ Ø§ÛŒØ¯Ù‡â€ŒØ¢Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ú©Ù…ØªØ± Ø§Ø² 10 Ø¯Ù‚ÛŒÙ‚Ù‡ Ú©Ø´Ù Ú©Ù†ÛŒØ¯. ØªØ­Ù„ÛŒÙ„ Ø¯Ù‚ÛŒÙ‚ Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø´ØºÙ„ÛŒ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡.">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css">
    <link rel="icon" href="{% static 'icon.jpg' %}?v=2" type="image/x-icon">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: 263 80% 55%;
            --primary-glow: 280 85% 65%;
            --background: 0 0% 100%;
            --foreground: 0 0% 10%;
            --secondary: 263 25% 95%;
            --secondary-foreground: 263 70% 40%;
            --muted: 263 15% 96%;
            --muted-foreground: 0 0% 50%;
            --border: 263 20% 90%;
            --card: 0 0% 100%;
            --card-foreground: 0 0% 10%;
        }

        body {
            font-family: 'Vazir', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }


        /* Home Page */
        .home-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background:  linear-gradient(135deg, hsl(var(--background)) 0%, hsl(263, 30%, 98%) 100%);
        }

        .home-container {
            max-width: 1000px;
            width: 100%;
            padding: 20px;
        }

        .home-title {
            text-align: center;
            margin-bottom: 60px;
        }

        .home-title h1 {
            font-size: 3.5rem;
            color: hsl(var(--primary));
            margin-bottom: 16px;
        }

        .home-title p {
            font-size: 1.25rem;
            color: hsl(var(--muted-foreground));
        }

        .home-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .home-button {
            background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary-glow)) 100%);
            border: none;
            border-radius: 16px;
            padding: 40px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            text-align: right;
            position: relative;
            overflow: hidden;
        }

        .home-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 40px hsla(var(--primary), 0.3);
        }

        .home-button.secondary {
            background: linear-gradient(135deg, hsl(var(--secondary)) 0%, hsl(var(--muted)) 100%);
        }

        .home-button-icon {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            margin-right: auto;
        }

        .home-button.secondary .home-button-icon {
            background: hsla(var(--primary), 0.1);
        }

        .home-button h2 {
            font-size: 1.75rem;
            color: white;
            margin-bottom: 8px;
        }

        .home-button.secondary h2 {
            color: hsl(var(--foreground));
        }

        .home-button p {
            color: rgba(255,255,255,0.9);
            font-size: 0.95rem;
        }

        .home-button.secondary p {
            color: hsl(var(--muted-foreground));
        }

        /* Test Flow */
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .progress-bar {
            background: hsl(var(--secondary));
            height: 8px;
            border-radius: 4px;
            margin-bottom: 40px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, hsl(var(--primary)) 0%, hsl(var(--primary-glow)) 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .question-card {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .question-title {
            font-size: 1.5rem;
            margin-bottom: 24px;
            color: hsl(var(--foreground));
        }

        .option-button {
            width: 100%;
            padding: 16px;
            margin-bottom: 12px;
            border: 2px solid hsl(var(--border));
            background: hsl(var(--background));
            border-radius: 8px;
            cursor: pointer;
            text-align: right;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .option-button:hover {
            border-color: hsl(var(--primary));
            background: hsl(var(--secondary));
        }

        .option-button.selected {
            border-color: hsl(var(--primary));
            background: hsl(var(--secondary));
            font-weight: 600;
        }

        .slider-container {
            margin: 24px 0;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: hsl(var(--secondary));
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: hsl(var(--primary));
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: hsl(var(--primary));
            cursor: pointer;
            border: none;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid hsl(var(--border));
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            margin-top: 32px;
        }

        .btn {
            padding: 12px 32px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary-glow)) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px hsla(var(--primary), 0.3);
        }

        .btn-secondary {
            background: hsl(var(--secondary));
            color: hsl(var(--foreground));
        }

        .btn-secondary:hover {
            background: hsl(var(--muted));
        }

        /* Results Page */
        .results-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .results-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .results-title {
            font-size: 2.5rem;
            color: hsl(var(--primary));
            margin-bottom: 16px;
        }

        .results-card {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
        }

        .career-item {
            padding: 16px;
            background: hsl(var(--secondary));
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .career-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: hsl(var(--primary));
            margin-bottom: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 32px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .home-title h1 {
                font-size: 2rem;
            }

            .home-buttons {
                grid-template-columns: 1fr;
            }
        }
        .slider {
        /* --track-fill is a variable we will control with JavaScript */
        background: linear-gradient(to left, hsl(var(--primary)) 0%, hsl(var(--primary)) var(--track-fill, 50%), hsl(var(--secondary)) var(--track-fill, 50%), hsl(var(--secondary)) 100%);
        }
        button, input, textarea, select {
        font-family: inherit;
        }
        /* Add this to your <style> block */
        #profile-button {
            background: hsl(var(--card));
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            position: fixed;
            top: 20px;
            right: 20px;
            left: auto;
            z-index: 1001;
            transition: transform 0.2s;
        }
        #profile-button:hover {
            transform: scale(1.1);
        }
        /* Loading Spinner */
            .loading-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 40px;
                text-align: center;
            }
            .spinner {
                width: 50px;
                height: 50px;
                border: 5px solid hsl(var(--secondary));
                border-top: 5px solid hsl(var(--primary));
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 20px;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            /* --- NEW UI ELEMENTS --- */

            /* 1. Profile Completeness Bar */
            .progress-container {
                margin-bottom: 24px;
            }
            .progress-label {
                display: flex;
                justify-content: space-between;
                font-size: 0.9rem;
                color: hsl(var(--muted-foreground));
                margin-bottom: 8px;
            }
            .progress-track {
                width: 100%;
                height: 10px;
                background: hsl(var(--secondary));
                border-radius: 5px;
                overflow: hidden;
            }
            .progress-bar-fill {
                height: 100%;
                background: linear-gradient(90deg, hsl(var(--primary)), #8b5cf6); /* Purple gradient */
                width: 0%;
                transition: width 1s ease-in-out;
            }

            /* 2. Prominent Transition Button (CTA) */
            .btn-cta {
                background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); /* Blue gradient */
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: bold;
                cursor: pointer;
                width: 100%;
                margin-top: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                transition: transform 0.2s;
            }
            .btn-cta:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            }

            /* 3. Better Review Items */
            .review-item {
                background: #fff;
                border: 1px solid hsl(var(--border));
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                border-right: 4px solid hsl(var(--secondary)); /* Subtle accent */
            }
            /* History Item Styling */
            .history-card {
                background: #fff;
                border: 1px solid hsl(var(--border));
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 16px;
                transition: all 0.2s ease;
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: relative;
                overflow: hidden;
            }
            .history-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                border-color: hsl(var(--primary));
            }
            .history-card::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 6px;
                background: hsl(var(--primary));
                border-radius: 3px 0 0 3px;
            }
            .history-info h3 {
                font-size: 1.1rem;
                color: hsl(var(--foreground));
                margin-bottom: 4px;
            }
            .history-meta {
                font-size: 0.85rem;
                color: hsl(var(--muted-foreground));
                display: flex;
                gap: 15px;
            }
            .history-status {
                font-size: 0.8rem;
                padding: 4px 10px;
                border-radius: 12px;
                background: #e0f2fe;
                color: #0284c7;
                font-weight: bold;
            }
            .profile-stats {
                display: flex;
                justify-content: space-around;
                gap: 10px;
                background: hsl(var(--secondary));
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 24px;
                text-align: center;
            }
            .stat-item {
                flex: 1;
            }
            .stat-value {
                font-size: 1.5rem;
                font-weight: bold;
                color: hsl(var(--primary));
            }
            .stat-label {
                font-size: 0.8rem;
                color: hsl(var(--muted-foreground));
                margin-top: 4px;
            }
            .premium-badge {
                background: linear-gradient(135deg, #f59e0b, #d97706);
                color: white;
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 0.7rem;
                font-weight: bold;
                display: inline-block;
                margin-left: 5px;
            }
            /* --- SIDEBAR (Balanced Theme) --- */
.sidebar {
    position: fixed; top: 0; right: 0; width: 280px; height: 100%;
    background: #ffffff; /* Clean White Body */
    color: #333;
    z-index: 2001;
    box-shadow: -5px 0 20px rgba(0,0,0,0.15);
    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    display: flex; flex-direction: column;
}
.sidebar.hidden { transform: translateX(100%); }

/* Vibrant Header */
.sidebar-header {
    padding: 25px 20px;
    background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary-glow)) 100%);
    color: white;
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.close-btn { background: none; border: none; color: white; font-size: 1.8rem; cursor: pointer; opacity: 0.9; }

/* Clean Items */
.sidebar-content { padding: 15px 0; overflow-y: auto; }
.sidebar-item {
    padding: 14px 24px; cursor: pointer; display: flex; align-items: center; gap: 14px;
    transition: all 0.2s; font-size: 1rem; color: #555;
    border-left: 4px solid transparent; /* Marker for hover */
}
.sidebar-item:hover {
    background: hsl(var(--secondary));
    color: hsl(var(--primary));
    border-left-color: hsl(var(--primary)); /* Purple accent on hover */
}
.sidebar-item span { font-size: 1.2rem; } /* Bigger Icons */

/* --- MENU BUTTON (Fixed & Smart) --- */
#menu-button {
    position: fixed; top: 20px; left: 20px; /* Moved to LEFT to separate from Profile */
    width: 48px; height: 48px;
    background: white; border-radius: 50%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: none; /* Hidden by default, JS will show it */
    align-items: center; justify-content: center;
    cursor: pointer; z-index: 1000;
    color: hsl(var(--primary));
    transition: transform 0.2s;
}
#menu-button:hover { transform: scale(1.1); 
}
/* Success Modal Styles */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); z-index: 3000;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(4px);
    opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
.modal-overlay.active { opacity: 1; pointer-events: all; }

.success-card {
    background: white; padding: 40px 30px; border-radius: 20px;
    text-align: center; max-width: 400px; width: 90%;
    transform: scale(0.8); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 20px 50px rgba(0,0,0,0.2);
}
.modal-overlay.active .success-card { transform: scale(1); }

.success-icon {
    width: 80px; height: 80px; margin: 0 auto 20px;
    background: #dcfce7; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #16a34a;
}
.success-icon svg { width: 40px; height: 40px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

    <!-- Main Content Container -->
    <div id="mainContent" class="main-content">
        
        <!-- 1. Home Page -->
        <div id="homePage" class="page-content hidden">
            <div class="home-page">
                <div class="home-container">
                    <div class="home-title">
                        <h1>Ú©Ø§ÙÙ†Ø§</h1>
                        <p>Ú©Ø´Ù Ù…Ø³ÛŒØ± Ø´ØºÙ„ÛŒ Ø§ÛŒØ¯Ù‡â€ŒØ¢Ù„ Ø¨Ø§ ØªØ³Øª Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ÛŒØ§Ø¨ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</p>
                    </div>
                    <div class="home-buttons">
                        <button class="home-button" id="startPrimaryBtn" onclick="showPage('user-info')">
                            <h2>Ø´Ø±ÙˆØ¹ ØªØ³Øª Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ÛŒØ§Ø¨ÛŒ</h2>
                            <p>Ø¯Ø± Ú©Ù…ØªØ± Ø§Ø² Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡ØŒ Ù…Ø³ÛŒØ± Ø´ØºÙ„ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ú©Ø´Ù Ú©Ù†ÛŒØ¯</p>
                        </button>
                        <button class="home-button secondary" onclick="loadTestsMenu()">
                            <h2>Ø¢Ø²Ù…ÙˆÙ† Ù‡Ø§ÛŒ Ø³Ø·Ø­ Ø³Ù†Ø¬ÛŒ</h2>
                            <p>Ø³Ù†Ø¬Ø´ Ø³Ø·Ø­ Ù…Ù‡Ø§Ø±Øª Ø¯Ø± Ø­ÙˆØ²Ù‡ Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù</p>
                        </button>
                        <button class="home-button" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);" onclick="loadSubscriptionPage()">
                            <h2>Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú© ÙˆÛŒÚ˜Ù‡</h2>
                            <p>Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ù‡ ØªÙ…Ø§Ù…ÛŒ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ Ùˆ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§</p>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Login / User Info Page -->
        <div id="userInfoPage" class="page-content hidden">
            <div class="test-container" style="padding-top: 80px;">
                <!-- Explanation Text -->
                <div style="text-align: center; margin-bottom: 24px; padding: 20px; background: hsl(var(--secondary)); border-radius: 12px; line-height: 1.8;">
                    <h2 style="color: hsl(var(--primary-glow)); margin-bottom: 16px;">Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù‡ÙˆØ´Ù…Ù†Ø¯ Ú©Ø§ÙÙ†Ø§</h2>
                    <p style="font-size: 1.1rem; color: #333;">
                        Ø¨Ø§ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ù‡ÙˆØ´Ù…Ù†Ø¯ Ú©Ø§ÙÙ†Ø§ Ù…Ø³ÛŒØ± Ø´ØºÙ„ÛŒØª Ø±Ùˆ Ø®Ù„Ù‚ Ú©Ù†
                    </p>
                </div>
                <!-- Login Form -->
                <div class="question-card">
                    <h2 class="question-title" style="text-align: center; margin-bottom: 32px;">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†</h2>
                    {% csrf_token %}
                    <div style="margin-bottom: 16px;">
                        <label for="userPhone">Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³(Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ) </label>
                        <input type="tel" id="userPhone" class="input-field" placeholder="Ù…Ø«Ø§Ù„: 09123456789" maxlength="11" pattern="09[0-9]{9}">   
                    </div>
                    <div style="margin-bottom: 32px;">
                        <label for="regFullName">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
                        <input type="text" id="regFullName" class="input-field" placeholder="Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">
                    </div>
                    <button id="requestOtpBtn" class="btn btn-primary" style="width: 100%;" onclick="requestOTP()">Ø¯Ø±ÛŒØ§ÙØª Ú©Ø¯ ØªØ§ÛŒÛŒØ¯</button>
                </div>
            </div>
        </div>

        <!-- 3. OTP Entry Page -->
        <div id="otpPage" class="page-content hidden">
            <div class="test-container" style="padding-top: 80px;">
                <div class="question-card">
                    <h2 class="question-title" style="text-align: center; margin-bottom: 32px;">Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</h2>
                    <p style="text-align: center; color: hsl(var(--muted-foreground)); margin-bottom: 24px;">
                        ÛŒÚ© Ú©Ø¯ Û¶ Ø±Ù‚Ù…ÛŒ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.
                    </p>
                    <div style="margin-bottom: 32px;">
                        <label for="otpCode" style="display: block; margin-bottom: 8px;">Ú©Ø¯ ØªØ§ÛŒÛŒØ¯</label>
                        <input type="text" id="otpCode" class="input-field" placeholder="Ú©Ø¯ Û¶ Ø±Ù‚Ù…ÛŒ..." inputmode="numeric" maxlength="6">
                    </div>
                    <button id="verifyOtpBtn" class="btn btn-primary" style="width: 100%;" onclick="verifyOTP()">ØªØ§ÛŒÛŒØ¯ Ùˆ ÙˆØ±ÙˆØ¯</button>
                </div>
            </div>
        </div>

        <!-- 4. Profile Panel Page -->
        <div id="profilePage" class="page-content hidden">
            <div class="test-container" style="padding-top: 80px;">
                <div class="question-card" id="profileForm">
                    <h2 class="question-title" style="text-align: center; margin-bottom: 32px;">Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø´Ù…Ø§</h2>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="color: #666; font-size: 0.9rem;">ÙˆØ¶Ø¹ÛŒØª Ø§Ø´ØªØ±Ø§Ú©:</span>
                            <div id="profileSubStatus" style="font-weight: bold; color: hsl(var(--primary)); margin-top: 4px;">--</div>
                        </div>
                        <button class="btn btn-secondary" style="font-size: 0.85rem; padding: 6px 12px;" onclick="loadSubscriptionPage()">Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø´ØªØ±Ø§Ú©</button>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ (ØºÛŒØ±Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±)</label>
                        <input type="text" id="profilePhone" class="input-field" readonly>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label for="profileFullName">Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
                        <input type="text" id="profileFullName" class="input-field" placeholder="Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label for="profileAge">Ø³Ù†</label>
                        <input type="number" id="profileAge" class="input-field" placeholder="Ø³Ù† Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯...">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label for="profileAddress">Ø¢Ø¯Ø±Ø³ (Ø´Ù‡Ø±)</label>
                        <input type="text" id="profileAddress" class="input-field" placeholder="Ø´Ù‡Ø± Ù…Ø­Ù„ Ø³Ú©ÙˆÙ†Øª...">
                    </div>
                    <div style="margin-bottom: 32px;">
                        <label for="profileAbout">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ù†</label>
                        <textarea id="profileAbout" class="input-field" rows="4" placeholder="Ú†Ù†Ø¯ Ø¬Ù…Ù„Ù‡ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø®ÙˆØ¯ØªØ§Ù†..."></textarea>
                    </div>

                    <div class="nav-buttons" style="justify-content: space-between;">
                        <button class="btn btn-secondary" onclick="logout()">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨</button>
                        <button id="saveProfileBtn" class="btn btn-primary" onclick="saveProfile()">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. History List Page -->
        <div id="historyPage" class="page-content hidden">
            <div class="results-container">
                <div class="results-header">
                    <h1 class="results-title">ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§</h1>
                    <p>Ù„ÛŒØ³Øª ØªÙ…Ø§Ù… Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒâ€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ ØªØ§ Ú©Ù†ÙˆÙ† Ø§Ù†Ø¬Ø§Ù… Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯.</p>
                </div>
                <div id="historyList" style="display: flex; flex-direction: column; gap: 16px;"></div>
                <div class="action-buttons" style="margin-top: 32px;">
                    <button class="btn btn-secondary" onclick="showProfilePanel()">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
                </div>
            </div>
        </div>

        <!-- 6. History Review Page (ReadOnly) -->
        <div id="historyReviewPage" class="page-content hidden">
            <div class="results-container">
                <div class="results-header">
                    <h1 class="results-title">Ù…Ø±ÙˆØ± Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡</h1>
                    <div id="historyMeta" style="color: hsl(var(--muted-foreground)); margin-top: 8px;"></div>
                </div>
                <div id="historyReviewContent" class="results-card"></div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="showPage('history')">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª</button>
                    <button id="viewAnalysisBtn" class="btn btn-primary" onclick="viewHistoryAnalysis()">Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</button>
                </div>
            </div>
        </div>

        <!-- 7. Skills Assessment Page (The Test) -->
        <div id="skillsAssessmentPage" class="page-content hidden">
            <div class="test-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <div id="questionContainer"></div>
                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="navigateTo('home')">Ø§Ù†ØµØ±Ø§Ù</button> 
                    <div> 
                        <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()">Ù‚Ø¨Ù„ÛŒ</button>
                        <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">Ø¨Ø¹Ø¯ÛŒ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 8. Review Answers Page (Before Submit) -->
        <div id="reviewPage" class="page-content hidden">
            <div class="results-container">
                <div class="results-header">
                    <h1 class="results-title">Ù…Ø±ÙˆØ± Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§</h1>
                    <p>Ù„Ø·ÙØ§ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯. Ø¯Ø± ØµÙˆØ±Øª ØªØ§ÛŒÛŒØ¯ØŒ ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.</p>
                </div>
                <div id="reviewContent" class="results-card"></div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="editAnswers()">ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§</button>
                    <button class="btn btn-primary" onclick="submitAnswers()">ØªØ§ÛŒÛŒØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù†Ù‡Ø§ÛŒÛŒ</button>
                </div>
            </div>
        </div>

        <!-- 9. Results Page (AI Output) -->
        <div id="resultsPage" class="page-content hidden">
            <div class="results-container">
                <div class="results-header">
                    <h1 class="results-title">Ù†ØªØ§ÛŒØ¬ ØªØ³Øª Ø´Ù…Ø§</h1>
                </div>
                <div id="resultsContent"></div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="navigateTo('home')">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø§Ù†Ù‡</button>
                    <button class="btn btn-primary" onclick="downloadResults()">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†ØªØ§ÛŒØ¬</button>
                    <button class="btn btn-primary" onclick="loadTestsMenu()">Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø³Ø·Ø­â€ŒØ³Ù†Ø¬ÛŒ</button>
                </div>
            </div>
        </div>

        <!-- 10. Tests Menu Page -->
        <div id="testsMenuPage" class="page-content hidden">
            <div class="results-container">
                <div class="results-header">
                    <h1 class="results-title">Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ ØªØ®ØµØµÛŒ</h1>
                    <p>Ø¨Ø±Ø§ÛŒ Ø³Ù†Ø¬Ø´ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±ØŒ ÛŒÚ©ÛŒ Ø§Ø² Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>
                </div>
                <div id="testsGrid" style="display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));"></div>
                <div class="action-buttons" style="margin-top: 32px;">
                    <button class="btn btn-secondary" onclick="showPage('home')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
                </div>
            </div>
        </div>

        <!-- 11. About Page -->
        <div id="aboutPage" class="page-content hidden">
            <div class="container">
                <h1 style="font-size: 2.5rem; margin-bottom: 32px;">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</h1>
                <div class="question-card">
                    <p>Ú©Ø§ÙÙ†Ø§ ÛŒÚ© Ù¾Ù„ØªÙØ±Ù… Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ÛŒØ§Ø¨ÛŒ Ø´ØºÙ„ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¨Ù‡ Ø§ÙØ±Ø§Ø¯ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯ ØªØ§ Ù…Ø³ÛŒØ± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø§ÛŒØ¯Ù‡â€ŒØ¢Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ú©Ø´Ù Ú©Ù†Ù†Ø¯.</p>
                </div>
            </div>
        </div>

        <!-- 12. Contact Page -->
        <div id="contactPage" class="page-content hidden">
            <div class="container">
                <h1 style="font-size: 2.5rem; margin-bottom: 32px;">ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø§</h1>
                <div class="question-card">
                    <p>Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø§ÛŒÙ…ÛŒÙ„ Ø²ÛŒØ± Ø¨Ø§ Ù…Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§Ø´ÛŒØ¯:</p>
                    <p style="font-weight: 600; margin-top: 16px;">support@kafna.ir</p>
                </div>
            </div>
        </div>

        <div id="subscriptionPage" class="page-content hidden">
            <div class="results-container" style="max-width: 900px;">
                <div class="results-header">
                    <h1 class="results-title" style="color: #d97706;">Ø§Ø±ØªÙ‚Ø§ Ø¨Ù‡ Ù†Ø³Ø®Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</h1>
                    <p>Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ ØªØ®ØµØµÛŒ Ùˆ Ù†Ù‚Ø´Ù‡â€ŒÛŒ Ø±Ø§Ù‡ Ø¯Ù‚ÛŒÙ‚ØŒ Ø§Ø´ØªØ±Ø§Ú© ØªÙ‡ÛŒÙ‡ Ú©Ù†ÛŒØ¯.</p>
                </div>
                
                <!-- Status Message Container -->
                <div id="subStatusMessage" style="margin-bottom: 30px;"></div>

                <!-- THE FIX: Everything is now inside ONE parent div -->
                <div>
                    <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">
                        <!-- Free Plan Card -->
                        <div class="question-card" id="freePlanCard" style="flex: 1; min-width: 300px; text-align: center;">
                            <div id="freePlanStatus"></div> 
                            <h3>Ù†Ø³Ø®Ù‡ Ø±Ø§ÛŒÚ¯Ø§Ù†</h3>
                            <div style="font-size: 2rem; font-weight: bold; margin: 20px 0;">Û° ØªÙˆÙ…Ø§Ù†</div>
                            <ul style="list-style: none; line-height: 2; padding: 0;">
                                <li>âœ… ØªØ³Øª Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ÛŒØ§Ø¨ÛŒ Ø§ÙˆÙ„ÛŒÙ‡</li>
                                <li>âœ… Ù…Ø´Ø§Ù‡Ø¯Ù‡ Û³ Ø´ØºÙ„ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ</li>
                                <li>âŒ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø³Ø·Ø­â€ŒØ³Ù†Ø¬ÛŒ ØªØ®ØµØµÛŒ</li>
                                <li>âŒ Ù†Ù‚Ø´Ù‡ Ø±Ø§Ù‡ Û¶ Ù…Ø§Ù‡Ù‡</li>
                            </ul>
                            <button id="freePlanBtn" class="btn btn-secondary" style="width: 100%; margin-top: 20px;">Ø·Ø±Ø­ ÙØ¹Ù„ÛŒ</button>
                        </div>

                        <!-- Pro Plan Card -->
                        <div class="question-card" id="proPlanCard" style="flex: 1; min-width: 300px; text-align: center; border: 2px solid hsl(var(--primary)); position: relative;">
                            <div id="proPlanStatus"></div> 
                            <div style="background: hsl(var(--primary)); color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; position: absolute; top: -15px; left: 50%; transform: translateX(-50%);">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ ÙˆÛŒÚ˜Ù‡</div>
                            <h3 style="color: hsl(var(--primary));">Ù†Ø³Ø®Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</h3>
                            <div style="font-size: 2rem; font-weight: bold; margin: 20px 0;">Û¹Û¹,Û°Û°Û° ØªÙˆÙ…Ø§Ù†</div>
                            <ul style="list-style: none; line-height: 2; padding: 0;">
                                <li>âœ… ØªØ³Øª Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ÛŒØ§Ø¨ÛŒ Ø§ÙˆÙ„ÛŒÙ‡</li>
                                <li>âœ… Ù…Ø´Ø§Ù‡Ø¯Ù‡ Û³ Ø´ØºÙ„ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ</li>
                                <li>âœ… <b>Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯</b> Ø¨Ù‡ ØªÙ…Ø§Ù… Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ ØªØ®ØµØµÛŒ</li>
                                <li>âœ… Ø¯Ø±ÛŒØ§ÙØª <b>Ù†Ù‚Ø´Ù‡ Ø±Ø§Ù‡ Ø¯Ù‚ÛŒÙ‚</b> Ùˆ Ù…Ù†Ø§Ø¨Ø¹ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ</li>
                            </ul>
                            <button id="proPlanBtn" class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="buySubscription()">Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©</button>
                        </div>
                    </div>

                    <!-- Promo Code Section -->
                    <div style="max-width: 400px; margin: 40px auto; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 12px;">
                        <h3 style="margin-bottom: 16px; font-size: 1.1rem;">Ú©Ø¯ ØªØ®ÙÛŒÙ ÛŒØ§ Ú©Ø¯ Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ</h3>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="promoCodeInput" class="input-field" placeholder="Ú©Ø¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." style="text-align: center;">
                            <button class="btn btn-primary" onclick="redeemCode()">Ø«Ø¨Øª</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--14. sidebar-->
        <!-- Sidebar Overlay (Click to close) -->
        <div id="sidebarOverlay" class="sidebar-overlay hidden" onclick="toggleSidebar()"></div>

        <!-- Sidebar Menu -->
        <div id="appSidebar" class="sidebar hidden">
            <div class="sidebar-header">
                <h2 style="color: white; margin: 0;">Ú©Ø§ÙÙ†Ø§</h2>
                <button class="close-btn" onclick="toggleSidebar()">Ã—</button>
            </div>
            <div class="sidebar-content">
                <div class="sidebar-item" onclick="toggleSidebar(); showPage('home')">
                    <span>ğŸ </span> Ø®Ø§Ù†Ù‡
                </div>
                <div class="sidebar-item" onclick="toggleSidebar(); showProfilePanel()">
                    <span>ğŸ‘¤</span> Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ù…Ù†
                </div>
                <div class="sidebar-item" onclick="toggleSidebar(); loadHistory()">
                    <span>ğŸ“…</span> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§
                </div>
                <div class="sidebar-item" onclick="toggleSidebar(); loadTestsMenu()">
                    <span>ğŸ“‹</span> Ù„ÛŒØ³Øª Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§
                </div>
                <div class="sidebar-item" onclick="toggleSidebar(); loadSubscriptionPage()">
                    <span>ğŸ’</span> Ø§Ø´ØªØ±Ø§Ú© ÙˆÛŒÚ˜Ù‡
                </div>
                <hr style="border-color: hsla(255, 100%, 100%, 0.1); margin: 10px 0;">
                <div class="sidebar-item" onclick="logout()" style="color: #fca5a5;">
                    <span>ğŸšª</span> Ø®Ø±ÙˆØ¬
                </div>
            </div>
        </div>

        <!-- Floating Menu Button (Visible on all pages) -->
        <div id="menu-button" onclick="toggleSidebar()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </div>

            </div> <!-- End of mainContent -->

    <!-- SCRIPTS START HERE -->
    <!-- (Your existing script block goes here) -->

            <!-- Success Modal Overlay -->
            <div id="successModal" class="modal-overlay hidden">
                <div class="success-card">
                    <div class="success-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    </div>
                    <h2>ØªØ¨Ø±ÛŒÚ© Ù…ÛŒâ€ŒÚ¯ÙˆÛŒÛŒÙ…!</h2>
                    <p>Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù†Ø³Ø®Ù‡ <b>ÙˆÛŒÚ˜Ù‡ (Premium)</b> Ø§Ø±ØªÙ‚Ø§ ÛŒØ§ÙØª.</p>
                    <p style="font-size: 0.9rem; color: #666; margin-bottom: 20px;">Ø§Ú©Ù†ÙˆÙ† Ø¨Ù‡ ØªÙ…Ø§Ù… Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ ØªØ®ØµØµÛŒ Ùˆ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø±ÛŒØ¯.</p>
                    <button class="btn btn-primary" style="width: 100%;" onclick="closeSuccessModal()">Ø´Ø±ÙˆØ¹ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ</button>
                </div>
            </div>
</body>

<script>
/* ==========================================================================
   1. GLOBAL UTILITIES (Defined at top to fix ReferenceError)
   ========================================================================== */
function linkEnterToNext(inputId, nextId) {
    const i = document.getElementById(inputId);
    const n = document.getElementById(nextId);
    if (i && n) {
        i.addEventListener('keyup', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                // If next is input, focus; if button, click
                if (n.tagName === 'INPUT' || n.tagName === 'TEXTAREA') n.focus();
                else n.click();
            }
        });
    }
}

function downloadResults() {
    const element = document.getElementById('resultsContent');
    html2canvas(element, { 
        scale: 2, 
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff'
    }).then(canvas => {
        const { jsPDF } = window.jspdf;
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const pageHeight = 297;
        let imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }

        pdf.save('Ù†ØªØ§ÛŒØ¬ ØªØ³Øª.pdf');
    }).catch(err => {
        console.error('PDF generation failed:', err);
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
    });
}
function toggleSidebar() {
    const sidebar = document.getElementById('appSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    if (sidebar.classList.contains('hidden')) {
        sidebar.classList.remove('hidden');
        overlay.classList.remove('hidden');
    } else {
        sidebar.classList.add('hidden');
        overlay.classList.add('hidden');
    }
}

/* ==========================================================================
   2. GLOBAL STATE
   ========================================================================== */
console.log("Script Initialized");
let currentQuestion = 0;
let answers = {};
let questions = [];
let currentTestId = null;
let currentTestName = '';
let historyDataCache = [];
let currentHistoryItem = null;

/* ==========================================================================
   3. NAVIGATION
   ========================================================================== */
function showPage(page, updateHistory = true) {
    console.log("Navigating to:", page);
    document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));

    const id = {
        home: 'homePage', 'user-info': 'userInfoPage',
        'skills-assessment': 'skillsAssessmentPage',
        results: 'resultsPage', otp: 'otpPage',
        profile: 'profilePage', review: 'reviewPage',
        'tests-menu': 'testsMenuPage', history: 'historyPage',
        'history-review': 'historyReviewPage',
        'subscription': 'subscriptionPage' 
    }[page];

    const el = document.getElementById(id);
    if (el) el.classList.remove('hidden');
    else { console.error("CRITICAL ERROR: Page element not found for ID:", id); return; }

    // --- 1. PROFILE BUTTON VISIBILITY (Top Right) ---
    const profileBtn = document.getElementById('profile-button');
    if (profileBtn) {
        // Only show on Home, Profile, or Results (if logged in)
        profileBtn.style.display = (page === 'home' || page === 'profile' || page === 'results') ? 'flex' : 'none';
    }

    // --- 2. MENU BUTTON VISIBILITY (Top Left) ---
    const menuBtn = document.getElementById('menu-button');
    if (menuBtn) {
        // Hide on Login and OTP pages. Show everywhere else.
        if (page === 'user-info' || page === 'otp') {
            menuBtn.style.display = 'none';
        } else {
            menuBtn.style.display = 'flex';
        }
    }

    if (updateHistory) history.pushState({ page: page }, '', `#${page}`);
}

function navigateTo(page) { showPage(page); }

window.onpopstate = function(event) {
    if (event.state && event.state.page) showPage(event.state.page, false);
    else showPage('{{ initial_page|default:"user-info" }}', false);
};

/* ==========================================================================
   4. AUTHENTICATION
   ========================================================================== */
function requestOTP() {
    const phone = document.getElementById('userPhone').value.trim();
    const fullName = document.getElementById('regFullName').value.trim();
    if (!phone || !fullName) { alert('Ù„Ø·ÙØ§ ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯.'); return; }
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch('/api/request-otp/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ phone_number: phone })
    }).then(r => r.json()).then(data => {
        if (data.status === 'success') {
            showPage('otp');
            setTimeout(() => document.getElementById('otpCode').focus(), 100);
        } else { alert('Ø®Ø·Ø§: ' + data.message); }
    });
}

function verifyOTP() {
    const phone = document.getElementById('userPhone').value.trim();
    const code = document.getElementById('otpCode').value.trim();
    const fullName = document.getElementById('regFullName').value.trim();
    if (!code || code.length !== 6) { alert('Ù„Ø·ÙØ§ Ú©Ø¯ Û¶ Ø±Ù‚Ù…ÛŒ Ø±Ø§ Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.'); return; }
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch('/api/verify-otp/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ phone_number: phone, code: code, full_name: fullName })
    }).then(r => r.json()).then(data => {
        if (data.status === 'success') window.location.href = '/';
        else alert('Ø®Ø·Ø§: ' + data.message);
    });
}

function logout() {
    if (confirm("Ø¢ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ Ø§Ø² Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø®ÙˆØ¯ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ\n\nØªÙˆØ¬Ù‡: Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ù…Ø¬Ø¯Ø¯ØŒ Ø¨Ø§ÛŒØ¯ Ù†Ø§Ù… Ùˆ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")) {
        window.location.href = '/logout/';
    }
}

function showProfilePanel() {
    const profilePage = document.getElementById('profilePage');
    if (!profilePage.classList.contains('hidden')) { showPage('home'); return; }

    showPage('profile');

    const profilePromise = fetch('/api/profile/').then(r => r.json());
    const rankPromise = fetch('/api/user-rank/').then(r => r.json());

    Promise.all([profilePromise, rankPromise])
        .then(([profileData, rankData]) => {
            if (profileData.status === 'success') {
                const p = profileData.profile;
                document.getElementById('profilePhone').value = p.phone_number;
                document.getElementById('profileFullName').value = p.full_name;
                document.getElementById('profileAge').value = p.age;
                document.getElementById('profileAddress').value = p.address;
                document.getElementById('profileAbout').value = p.about_me;
            }

            const statusEl = document.getElementById('profileSubStatus');
            if (window.userIsPremium) {
                statusEl.innerHTML = '<span style="color: #d97706;">âœ¨ ÙˆÛŒÚ˜Ù‡ (Premium)</span>';
            } else {
                statusEl.innerHTML = '<span style="color: #666;">Ø±Ø§ÛŒÚ¯Ø§Ù†</span>';
            }

            if (rankData.status === 'success') {
                const statsContainer = document.getElementById('profileStats');
                if (statsContainer) {
                    statsContainer.innerHTML = `
                        <div class="stat-item">
                            <div class="stat-value">${rankData.assessment_count}</div>
                            <div class="stat-label">Ø¢Ø²Ù…ÙˆÙ† ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${window.userIsPremium ? 'ÙˆÛŒÚ˜Ù‡ âœ¨' : 'Ø±Ø§ÛŒÚ¯Ø§Ù†'}</div>
                            <div class="stat-label">ÙˆØ¶Ø¹ÛŒØª Ø­Ø³Ø§Ø¨</div>
                        </div>
                    `;
                }
            }

            const saveBtn = document.getElementById('saveProfileBtn');
            saveBtn.disabled = true;
            saveBtn.style.opacity = '0.5';
            const form = document.getElementById('profileForm');
            form.addEventListener('input', () => {
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
                saveBtn.style.cursor = 'pointer';
            }, { once: true });
        })
        .catch(err => {
            console.error("Error loading profile data:", err);
            const statusEl = document.getElementById('profileSubStatus');
            if (statusEl) statusEl.innerHTML = '<span style="color: red;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</span>';
        });
}

function saveProfile() {
    const data = {
        full_name: document.getElementById('profileFullName').value,
        age: document.getElementById('profileAge').value,
        address: document.getElementById('profileAddress').value,
        about_me: document.getElementById('profileAbout').value,
    };
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch('/api/profile/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify(data)
    }).then(r => r.json()).then(d => {
        if (d.status === 'success') { alert('Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.'); showPage('home'); }
        else { alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡.'); }
    });
}

function closeSuccessModal() {
    document.getElementById('successModal').classList.remove('active');
    window.location.reload(); // Reload to update the premium state everywhere
}

function buySubscription() {
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch('/api/subscription/', { 
        method: 'POST',
        headers: {'X-CSRFToken': csrf}
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            // THE FIX: Show the nice modal instead of alert
            document.getElementById('successModal').classList.add('active');
            
            // Optional: Trigger confetti if you add a library later
        } else {
            alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªÙ‚Ø§ Ø­Ø³Ø§Ø¨.");
        }
    });
}

function redeemCode() {
    const code = document.getElementById('promoCodeInput').value;
    if (!code) return;
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch('/api/redeem-code/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
        body: JSON.stringify({ code: code })
    }).then(r => r.json()).then(data => {
        if (data.status === 'success') {
            // THE FIX: Show the nice modal
            document.getElementById('successModal').classList.add('active');
        } else {
            alert(data.message);
        }
    });
}

/* ==========================================================================
   5. TESTS & EXECUTION
   ========================================================================== */
function loadTestsMenu() {
    showPage('tests-menu');
    const container = document.getElementById('testsGrid');
    container.innerHTML = '<div class="loading-container"><div class="spinner"></div></div>';

    fetch('/api/tests/list/')
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success' && data.tests.length > 0) {
                container.innerHTML = data.tests.map(test => `
                    <div class="question-card" style="cursor: pointer; transition: transform 0.2s; height: 100%; display: flex; flex-direction: column; justify-content: space-between;" 
                         onmouseover="this.style.transform='scale(1.02)'" 
                         onmouseout="this.style.transform='scale(1)'"
                         onclick="startSpecificTest(${test.id}, '${test.name}')">
                        <div>
                            <h3 style="color: hsl(var(--primary)); margin-bottom: 8px;">${test.name}</h3>
                            <p style="color: hsl(var(--muted-foreground)); font-size: 0.9rem; line-height: 1.6;">${test.description || 'Ø³Ù†Ø¬Ø´ ØªØ®ØµØµÛŒ Ù…Ù‡Ø§Ø±Øªâ€ŒÙ‡Ø§'}</p>
                        </div>
                        <button class="btn btn-primary" style="width: 100%; margin-top: 16px;">Ø´Ø±ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ†</button>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="question-card" style="grid-column: 1/-1; text-align: center;"><p>ÙØ¹Ù„Ø§Ù‹ Ø¢Ø²Ù…ÙˆÙ† ØªØ®ØµØµÛŒ Ø¯ÛŒÚ¯Ø±ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.</p></div>';
            }
        })
        .catch(err => {
            console.error(err);
            container.innerHTML = '<p style="color: red;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§.</p>';
        });
}

function startSpecificTest(testId, testName = 'Ø¢Ø²Ù…ÙˆÙ†') {
    const startTestId = "{{ start_test_id|default:'' }}"; 
    const isPremium = "{{ user.is_premium|yesno:'true,false' }}" === "true"; 
    if (testId.toString() !== startTestId && !isPremium) {
        showPage('subscription'); return;
    }
    currentTestId = testId;
    currentTestName = testName;
    answers = {};
    const saved = localStorage.getItem(`draft_answers_${testId}`);
    if (saved) { try { answers = JSON.parse(saved); } catch(e) { answers = {}; } }
    loadQuestions(testId);
    showPage('skills-assessment');
}

function loadQuestions(testId) {
    currentQuestion = 0;
    console.log("Fetching questions for Test ID:", testId);
    fetch(`/api/tests/${testId}/questions/`).then(r => r.json()).then(data => {
        console.log("Questions API Response:", data);
        questions = data;
        if (questions.length > 0) {
            showPage('skills-assessment');
            renderQuestion();
        } else { document.getElementById('questionContainer').innerHTML = '<p>Ø³ÙˆØ§Ù„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>'; }
    }).catch(err => console.error(err));
}

// --- RENDER ---
function renderQuestion() {
    const q = questions[currentQuestion];
    const container = document.getElementById('questionContainer');
    if (!container) return;
    const progress = ((currentQuestion + 1) / questions.length) * 100;
    document.getElementById('progressBar').style.width = `${progress}%`;

    let html = `<div class="question-card">
        <p style="color:hsl(var(--muted-foreground));margin-bottom:8px;">Ø³ÙˆØ§Ù„ ${currentQuestion + 1} Ø§Ø² ${questions.length}</p>
        <h2 class="question-title">${q.question}</h2>`;

    if (q.type === 'multiple') {
        html += '<div>';
        q.options.forEach(opt => {
            const sel = answers[q.id] === opt ? 'selected' : '';
            const esc = opt.replace(/'/g, "\\'");
            html += `<button class="option-button ${sel}" onclick="selectOption(${q.id}, '${esc}')">${opt}</button>`;
        });
        html += '</div>';
    } else if (q.type === 'slider') {
        const val = answers[q.id] ?? 5;
        html += `<div class="slider-container"><input type="range" class="slider" min="${q.min}" max="${q.max}" value="${val}" oninput="updateSlider(${q.id}, this)"><div style="display:flex;justify-content:space-between;font-weight:600;margin-top:8px;"><span>${q.min}</span><span id="sliderValue-${q.id}">${val}</span><span>${q.max}</span></div><div style="display:flex;justify-content:space-between;font-size:.85rem;padding:0 4px;"><span>Ù…Ø®Ø§Ù„ÙÙ…</span><span>Ù…ÙˆØ§ÙÙ‚Ù…</span></div></div>`;
    } else if (q.type === 'text') {
        const val = answers[q.id] ?? '';
        html += `<input type="text" id="textAnswerInput" class="input-field" value="${val}" oninput="updateText(${q.id}, this.value)" placeholder="...">`;
    }
    html += '</div>';
    container.innerHTML = html;

    // Auto-focus text input
    if (q.type === 'text') {
        setTimeout(() => document.getElementById('textAnswerInput').focus(), 100);
    }

    if (q.type === 'slider') updateSliderFill(container.querySelector('.slider'));

    document.onkeyup = null;
    if (q.type === 'text') linkEnterToNext('textAnswerInput', 'nextBtn');
    else {
        document.onkeyup = function(event) {
            if (event.key === 'Enter') { event.preventDefault(); document.getElementById('nextBtn').click(); }
        };
    }
    document.getElementById('prevBtn').disabled = currentQuestion === 0;
    document.getElementById('nextBtn').textContent = currentQuestion === questions.length - 1 ? 'Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†ØªØ§ÛŒØ¬' : 'Ø¨Ø¹Ø¯ÛŒ';
}

function selectOption(id, opt) { answers[id] = opt; saveProgress(); renderQuestion(); }
function updateSlider(id, el) {
    const val = parseInt(el.value);
    answers[id] = val;
    document.getElementById(`sliderValue-${id}`).textContent = val;
    updateSliderFill(el);
    saveProgress();
}
function updateSliderFill(el) {
    const pct = ((el.value - el.min) / (el.max - el.min)) * 100;
    el.style.setProperty('--track-fill', `${pct}%`);
}
function updateText(id, val) { answers[id] = val.trim(); saveProgress(); }
function saveProgress() { if (currentTestId) localStorage.setItem(`draft_answers_${currentTestId}`, JSON.stringify(answers)); }

function nextQuestion() {
    const q = questions[currentQuestion];
    const ans = answers[q.id];
    if (ans === undefined || ans === '') { alert("Ù„Ø·ÙØ§ Ù¾Ø§Ø³Ø® Ø¯Ù‡ÛŒØ¯."); return; }
    if (currentQuestion < questions.length - 1) { currentQuestion++; renderQuestion(); }
    else { showReviewPage(); }
}
function previousQuestion() { if (currentQuestion > 0) { currentQuestion--; renderQuestion(); } }

function showReviewPage() {
    showPage('review');
    const container = document.getElementById('reviewContent');
    container.innerHTML = questions.map(q => `
        <div class="review-item">
            <p style="font-size:1rem;font-weight:500;margin-bottom:8px;">${q.question}</p>
            <div style="background:hsl(var(--secondary));padding:10px;border-radius:8px;color:hsl(var(--primary));">${answers[q.id] || '---'}</div>
        </div>`).join('');
}
function editAnswers() { showPage('skills-assessment'); }

function loadSubscriptionPage() {
    showPage('subscription');
    
    // Get all elements
    const freeStatus = document.getElementById('freePlanStatus');
    const proStatus = document.getElementById('proPlanStatus');
    const proBtn = document.getElementById('proPlanBtn');

    // Clear previous states
    freeStatus.innerHTML = '';
    proStatus.innerHTML = '';
    proBtn.disabled = false;
    proBtn.textContent = "Ø®Ø±ÛŒØ¯ Ø§Ø´ØªØ±Ø§Ú©";

    const activeStatusHtml = `
        <div style="background: hsl(var(--primary)); color: white; font-weight: bold; padding: 8px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
            âœ” Ø·Ø±Ø­ ÙØ¹Ù„ÛŒ Ø´Ù…Ø§
        </div>`;
    
    if (window.userIsPremium) {
        proStatus.innerHTML = activeStatusHtml;
        proBtn.disabled = true;
        proBtn.textContent = "ÙØ¹Ø§Ù„ Ø§Ø³Øª";
    } else {
        freeStatus.innerHTML = activeStatusHtml;
        // Make sure pro button is clickable
        proBtn.onclick = function() { buySubscription(); };
    }
}

/* ==========================================================================
   6. SUBMIT & RESULTS (Two-Step with Retry)
   ========================================================================== */
function submitAnswers(retryCount = 0) {
    showPage('results');
    const resultsContainer = document.getElementById('resultsContent');
    
    // Updated Loading Messages (stays longer, stops at final)
    const messages = [
        "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§...", 
        "Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„...", 
        "Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ø·Ø¨Ø§Ù‚ Ø´ØºÙ„ÛŒ...", 
        "ØªØ¯ÙˆÛŒÙ† Ù†Ù‚Ø´Ù‡ Ø±Ø§Ù‡..."
    ];
    let msgIndex = 0;
    resultsContainer.innerHTML = `
        <div class="loading-container">
            <div class="spinner"></div>
            <h3 id="loadingText" style="color:hsl(var(--primary));margin-bottom:10px;">${messages[0]}</h3>
            <p>Ù„Ø·ÙØ§Ù‹ Ø´Ú©ÛŒØ¨Ø§ Ø¨Ø§Ø´ÛŒØ¯</p>
        </div>`;
    
    // CHANGED: 4000ms (4 seconds) instead of 2500ms, and stops at last message
    const loadingInterval = setInterval(() => {
        msgIndex++;
        if (msgIndex < messages.length) {
            const el = document.getElementById('loadingText');
            if(el) el.textContent = messages[msgIndex];
        } else {
            // Stop at the last message - don't loop back
            clearInterval(loadingInterval);
        }
    }, 4000); // Changed from 2500 to 4000ms

    const submissionData = { user_info: {}, responses: [] };
    questions.forEach(q => {
        if (answers[q.id] !== undefined) {
            submissionData.responses.push({ question_id: q.id, question_text: q.question, answer: answers[q.id] });
        }
    });

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Step 1: Save Draft
    fetch(`/api/tests/${currentTestId}/save-draft/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify(submissionData)
    })
    .then(r => r.json())
    .then(draftData => {
        if (draftData.status !== 'success') throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§");
        localStorage.removeItem(`draft_answers_${currentTestId}`);
        return performAnalysis(currentTestId, draftData.result_id, submissionData, retryCount, loadingInterval);
    })
    .catch(err => {
        clearInterval(loadingInterval);
        console.error(err);
        resultsContainer.innerHTML = `<p style="color:red;text-align:center;">${err.message}</p><button class="btn btn-primary" onclick="submitAnswers()">ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯</button>`;
    });
}

function performAnalysis(testId, resultId, submissionData, retryCount, intervalId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const resultsContainer = document.getElementById('resultsContent');

    fetch(`/api/tests/${testId}/analyze/${resultId}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }
    })
    .then(r => r.json())
    .then(data => {
        clearInterval(intervalId);
        if (data.status === 'success') {
            const testObj = questions.length > 0 ? {sources: data.sources} : {};
            showResults(submissionData, data.analysis, currentTestName, data.sources);
        } else {
            throw new Error(data.message || "Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„");
        }
    })
    .catch(err => {
        if (retryCount < 2) {
            setTimeout(() => performAnalysis(testId, resultId, submissionData, retryCount + 1, intervalId), 2000);
        } else {
            clearInterval(intervalId);
            resultsContainer.innerHTML = `
                <div class="results-card" style="text-align: center;">
                    <h3 style="color: orange;">ØªØ­Ù„ÛŒÙ„ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯</h3>
                    <p>Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ Ø§Ù…Ø§ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯.</p>
                    <p style="font-size: 0.9rem; color: gray;">${err.message}</p>
                    <button class="btn btn-primary" onclick="performAnalysis(${testId}, ${resultId}, null, 0)">ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯</button>
                    <button class="btn btn-secondary" style="margin-top:10px;" onclick="showPage('home')">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø§Ù†Ù‡</button>
                </div>`;
        }
    });
}

function showResults(userData, analysis, testName, sources) {
    const container = document.getElementById('resultsContent');
    if (!container) return;

    const userName = "{{ user.full_name|default:'Ú©Ø§Ø±Ø¨Ø±' }}";
    const title = testName || "Ù†ØªÛŒØ¬Ù‡ Ø¢Ø²Ù…ÙˆÙ†";
    document.querySelector('#resultsPage .results-header h1').textContent = `${title} Ù†ØªÛŒØ¬Ù‡`;

    let html = '';

    if (!analysis) {
        html = '<div class="results-card"><p>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.</p></div>';
    } else if (typeof analysis === 'string') {
        html = `<div class="results-card"><p>${analysis}</p></div>`;
    } else {
        // 1. MBTI / General (Gradient Card)
        if (analysis.mbti || analysis.analysis) {
            html += `
            <div class="results-card" style="background: linear-gradient(135deg, hsl(var(--secondary)) 0%, #fff 100%); border: 1px solid hsl(var(--primary));">
                <h2 style="color: hsl(var(--primary)); margin-bottom: 16px;">ØªØ­Ù„ÛŒÙ„ Ú©Ù„ÛŒ</h2>
                ${analysis.mbti ? `
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
                        <h3 style="font-size: 2rem; color: hsl(var(--foreground));">${analysis.mbti.type || ''}</h3>
                        <span style="background:hsl(var(--primary)); color:white; padding:4px 12px; border-radius:20px; font-size:0.8rem;">${analysis.dominant_domain || 'General'}</span>
                    </div>
                    <p style="color: hsl(var(--muted-foreground)); margin-top:10px; line-height:1.7;">${analysis.mbti.description || ''}</p>
                ` : `<p style="line-height:1.7;">${analysis.analysis}</p>`}
            </div>`;
        }

        // 2. Recommended Jobs (With CTA Buttons)
        if (analysis.recommended_jobs && analysis.recommended_jobs.length > 0) {
            html += `
            <div class="results-card">
                <h2 style="color: hsl(var(--primary)); margin-bottom: 24px;">Ø´ØºÙ„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ</h2>
                ${analysis.recommended_jobs.map((career, index) => `
                    <div class="career-item" style="margin-bottom: 16px; padding: 20px; border: 1px solid hsl(var(--border)); border-radius: 12px; position: relative; overflow: hidden;">
                        ${index === 0 ? '<div style="position:absolute; top:0; left:0; background:hsl(var(--primary)); color:white; padding:4px 12px; font-size:0.7rem; border-bottom-right-radius:12px;">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø§ØµÙ„ÛŒ</div>' : ''}
                        
                        <div class="career-title" style="font-weight: bold; font-size: 1.2rem; color: #263b80; margin-top:10px;">${career.job}</div>
                        <p style="color: hsl(var(--foreground)); margin-bottom: 16px; font-size: 0.95rem;">${career.reason}</p>
                        
                        ${career.test_id ? `
                            <button class="btn btn-primary" style="width:100%; display:flex; justify-content:center; align-items:center; gap:8px;" 
                                    onclick="startSpecificTest(${career.test_id}, '${career.job}')">
                                <span>Ø³Ù†Ø¬Ø´ Ø³Ø·Ø­ ØªØ®ØµØµÛŒ Ø§ÛŒÙ† Ù…Ù‡Ø§Ø±Øª</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </button>
                        ` : ''}
                    </div>
                `).join('')}
            </div>`;
        }

        // 3. Development Path (Fancy List)
        const devPath = analysis.development_path || analysis.development_points;
        if (devPath && devPath.length > 0) {
            html += `
            <div class="results-card">
                <h2 style="color: hsl(var(--primary)); margin-bottom: 16px;">Ù…Ø³ÛŒØ± Ø±Ø´Ø¯ Ùˆ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ</h2>
                <ul style="list-style-type: none; padding: 0;">
                    ${devPath.map(step => `
                        <li style="margin-bottom: 12px; padding: 16px; background: #fff; border-radius: 8px; border-right: 4px solid hsl(var(--primary)); box-shadow: 0 2px 8px rgba(0,0,0,0.05); display:flex; align-items:center;">
                            <span style="color:hsl(var(--primary)); font-size:1.2rem; margin-left:10px;">â€¢</span>
                            ${step}
                        </li>
                    `).join('')}
                </ul>
            </div>`;
        }

        if (sources && Array.isArray(sources) && sources.length > 0) {
            html += `
            <div class="results-card">
                <h2 style="color: hsl(var(--primary)); margin-bottom: 20px; font-size: 1.2rem;">ğŸ“š Ù…Ù†Ø§Ø¨Ø¹ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ</h2>
                <div style="display: grid; gap: 14px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                    ${sources.map(source => `
                        <a href="${source.link}" target="_blank" rel="noopener noreferrer" 
                        style="text-decoration: none; padding: 18px; background: white; border: 2px solid hsl(var(--border)); border-radius: 12px; transition: all 0.3s; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer;"
                        onmouseover="this.style.borderColor='hsl(var(--primary))'; this.style.boxShadow='0 6px 16px rgba(139, 92, 246, 0.15)'; this.style.transform='translateY(-4px)';"
                        onmouseout="this.style.borderColor='hsl(var(--border))'; this.style.boxShadow='none'; this.style.transform='translateY(0)';">
                            <div>
                                <h4 style="color: hsl(var(--primary)); margin-bottom: 10px; font-size: 1rem; font-weight: 600;">${source.title}</h4>
                                <p style="font-size: 0.9rem; color: hsl(var(--muted-foreground)); line-height: 1.6;">${source.description}</p>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; color: hsl(var(--primary)); font-size: 0.85rem; font-weight: 600; margin-top: 14px;">
                                <span>â†’ Ø¯ÛŒØ¯Ù† Ù…Ù†Ø¨Ø¹</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </div>
                        </a>
                    `).join('')}
                </div>
            </div>
            `;
        }
    }
    container.innerHTML = html;
}

/* ==========================================================================
   7. HISTORY
   ========================================================================== */
function loadHistory() {
    showPage('history');
    const container = document.getElementById('historyList');
    container.innerHTML = '<div class="loading-container"><div class="spinner"></div></div>';

    fetch('/api/history/')
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success' && data.history.length > 0) {
                historyDataCache = data.history;
                
                container.innerHTML = data.history.map((item, index) => {
                    const hasAnalysis = item.analysis && Object.keys(item.analysis).length > 0;
                    const statusBadge = hasAnalysis 
                        ? '<span style="font-size:0.8rem; padding:4px 10px; border-radius:12px; background:#dcfce7; color:#166534;">ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡</span>' 
                        : '<span style="font-size:0.8rem; padding:4px 10px; border-radius:12px; background:#fff7ed; color:#9a3412;">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù„ÛŒÙ„</span>';

                    return `
                    <div class="question-card" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-right: 4px solid hsl(var(--primary));" 
                         onclick="openHistoryItem(${index})">
                        <div>
                            <h3 style="font-size: 1.1rem; color: hsl(var(--primary)); margin-bottom: 4px;">${item.test_name}</h3>
                            <div style="font-size: 0.85rem; color: hsl(var(--muted-foreground));">
                                <span>ğŸ“… ${item.date}</span> | <span>â° ${item.time}</span>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;">
                            ${statusBadge}
                            <button class="btn btn-secondary" style="font-size: 0.85rem; padding: 6px 12px;">Ù…Ø´Ø§Ù‡Ø¯Ù‡</button>
                        </div>
                    </div>`;
                }).join('');
            } else {
                container.innerHTML = '<div class="question-card" style="text-align:center;"><p>Ù‡Ù†ÙˆØ² Ø¢Ø²Ù…ÙˆÙ†ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.</p></div>';
            }
        })
        .catch(err => {
            console.error(err);
            container.innerHTML = '<p style="color:red; text-align:center;">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ®Ú†Ù‡.</p>';
        });
}

function openHistoryItem(index) {
    const item = historyDataCache[index];
    if (!item) return;
    currentHistoryItem = item;

    showPage('history-review');
    document.getElementById('historyMeta').textContent = `Ø¢Ø²Ù…ÙˆÙ†: ${item.test_name} | ØªØ§Ø±ÛŒØ®: ${item.date}`;
    
    const responses = item.answers.responses || [];
    let html = responses.map(r => `
        <div class="review-item">
            <p style="font-weight:500; margin-bottom:5px;">${r.question_text}</p>
            <div style="background:hsl(var(--secondary)); padding:8px; border-radius:6px; color:hsl(var(--primary));">
                ${r.answer}
            </div>
        </div>`).join('') || '<p>Ø¬Ø²Ø¦ÛŒØ§Øª Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.</p>';

    document.getElementById('historyReviewContent').innerHTML = html;

    const btn = document.getElementById('viewAnalysisBtn');
    if (item.analysis) {
        btn.style.display = 'inline-block';
        btn.textContent = "Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªØ­Ù„ÛŒÙ„ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ";
        btn.onclick = function() {
            showPage('results');
            showResults(item.answers, item.analysis, item.test_name, item.sources);
            const backBtn = document.querySelector('#resultsPage .action-buttons .btn-secondary');
            if(backBtn) {
                backBtn.onclick = function() { showPage('history-review'); };
                backBtn.textContent = "Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ø±ÙˆØ±";
            }
        };
    } else {
        btn.style.display = 'none';
    }
}

function viewHistoryAnalysis() {
    if (!currentHistoryItem || !currentHistoryItem.analysis) return;
    
    // Pass the test name from the history item to showResults
    showResults(currentHistoryItem.answers, currentHistoryItem.analysis, currentHistoryItem.test_name, currentHistoryItem.sources);
    
    // Override the back button on the results page
    const backBtn = document.querySelector('#resultsPage .action-buttons .btn-secondary');
    if(backBtn) {
        backBtn.onclick = function() { showPage('history-review'); };
        backBtn.textContent = "Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ø±ÙˆØ±";
    }
}

/* ==========================================================================
   8. INIT
   ========================================================================== */
document.addEventListener('DOMContentLoaded', () => {
    const initialPage = '{{ initial_page|default:"user-info" }}';
    const isAuthenticated = {{ is_authenticated|yesno:"true,false" }};
    const startTestId = "{{ start_test_id|default:'' }}";

    // Smart Refresh
    let targetPage = initialPage;
    if (isAuthenticated) {
        const hash = window.location.hash.substring(1);
        if (hash && ['home','profile','history','tests-menu','skills-assessment'].includes(hash)) targetPage = hash;
    }
    showPage(targetPage, false);

    // Resume Test Logic
    if (targetPage === 'skills-assessment' && isAuthenticated) {
        const activeId = localStorage.getItem('active_test_id');
        if (activeId) loadQuestions(activeId);
        else if (startTestId) startSpecificTest(startTestId, 'Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ÛŒØ§Ø¨ÛŒ');
        else showPage('home');
    }

    window.userIsPremium = {{ user.is_premium|yesno:"true,false" }};
    // Primary Button Logic
    if (isAuthenticated && startTestId) {
        const btn = document.getElementById('startPrimaryBtn');
        if (btn) btn.onclick = () => startSpecificTest(startTestId, 'Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ÛŒØ§Ø¨ÛŒ');
    }

    linkEnterToNext('regFullName', 'userPhone');
    linkEnterToNext('userPhone', 'requestOtpBtn');
    linkEnterToNext('otpCode', 'verifyOtpBtn');
    setTimeout(() => document.getElementById('userPhone').focus(), 100);
});
</script>
</body>
</html>