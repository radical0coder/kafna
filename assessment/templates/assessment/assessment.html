{% load static %}
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>کافنا - تست استعدادیابی هوشمند</title>
    <meta name="description" content="با تست استعدادیابی شغلی هوش مند کافنا، مسیر شغلی ایده‌آل خود را در کمتر از 10 دقیقه کشف کنید. تحلیل دقیق و پیشنهادات شغلی شخصی‌سازی شده.">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css">
    <link rel="icon" href="{% static 'icon.jpg' %}" type="image/x-icon">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: 263 80% 55%;
            --primary-glow: 280 85% 65%;
            --background: 0 0% 100%;
            --foreground: 0 0% 10%;
            --secondary: 263 25% 95%;
            --secondary-foreground: 263 70% 40%;
            --muted: 263 15% 96%;
            --muted-foreground: 0 0% 50%;
            --border: 263 20% 90%;
            --card: 0 0% 100%;
            --card-foreground: 0 0% 10%;
        }

        body {
            font-family: 'Vazir', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }


        /* Home Page */
        .home-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background:  linear-gradient(135deg, hsl(var(--background)) 0%, hsl(263, 30%, 98%) 100%);
        }

        .home-container {
            max-width: 1000px;
            width: 100%;
            padding: 20px;
        }

        .home-title {
            text-align: center;
            margin-bottom: 60px;
        }

        .home-title h1 {
            font-size: 3.5rem;
            color: hsl(var(--primary));
            margin-bottom: 16px;
        }

        .home-title p {
            font-size: 1.25rem;
            color: hsl(var(--muted-foreground));
        }

        .home-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .home-button {
            background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary-glow)) 100%);
            border: none;
            border-radius: 16px;
            padding: 40px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            text-align: right;
            position: relative;
            overflow: hidden;
        }

        .home-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 40px hsla(var(--primary), 0.3);
        }

        .home-button.secondary {
            background: linear-gradient(135deg, hsl(var(--secondary)) 0%, hsl(var(--muted)) 100%);
        }

        .home-button-icon {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            margin-right: auto;
        }

        .home-button.secondary .home-button-icon {
            background: hsla(var(--primary), 0.1);
        }

        .home-button h2 {
            font-size: 1.75rem;
            color: white;
            margin-bottom: 8px;
        }

        .home-button.secondary h2 {
            color: hsl(var(--foreground));
        }

        .home-button p {
            color: rgba(255,255,255,0.9);
            font-size: 0.95rem;
        }

        .home-button.secondary p {
            color: hsl(var(--muted-foreground));
        }

        /* Test Flow */
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .progress-bar {
            background: hsl(var(--secondary));
            height: 8px;
            border-radius: 4px;
            margin-bottom: 40px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, hsl(var(--primary)) 0%, hsl(var(--primary-glow)) 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .question-card {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .question-title {
            font-size: 1.5rem;
            margin-bottom: 24px;
            color: hsl(var(--foreground));
        }

        .option-button {
            width: 100%;
            padding: 16px;
            margin-bottom: 12px;
            border: 2px solid hsl(var(--border));
            background: hsl(var(--background));
            border-radius: 8px;
            cursor: pointer;
            text-align: right;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .option-button:hover {
            border-color: hsl(var(--primary));
            background: hsl(var(--secondary));
        }

        .option-button.selected {
            border-color: hsl(var(--primary));
            background: hsl(var(--secondary));
            font-weight: 600;
        }

        .slider-container {
            margin: 24px 0;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: hsl(var(--secondary));
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: hsl(var(--primary));
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: hsl(var(--primary));
            cursor: pointer;
            border: none;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid hsl(var(--border));
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            margin-top: 32px;
        }

        .btn {
            padding: 12px 32px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary-glow)) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px hsla(var(--primary), 0.3);
        }

        .btn-secondary {
            background: hsl(var(--secondary));
            color: hsl(var(--foreground));
        }

        .btn-secondary:hover {
            background: hsl(var(--muted));
        }

        /* Results Page */
        .results-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .results-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .results-title {
            font-size: 2.5rem;
            color: hsl(var(--primary));
            margin-bottom: 16px;
        }

        .results-card {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
        }

        .career-item {
            padding: 16px;
            background: hsl(var(--secondary));
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .career-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: hsl(var(--primary));
            margin-bottom: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 32px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .home-title h1 {
                font-size: 2rem;
            }

            .home-buttons {
                grid-template-columns: 1fr;
            }
        }
        .slider {
        /* --track-fill is a variable we will control with JavaScript */
        background: linear-gradient(to left, hsl(var(--primary)) 0%, hsl(var(--primary)) var(--track-fill, 50%), hsl(var(--secondary)) var(--track-fill, 50%), hsl(var(--secondary)) 100%);
        }
        button, input, textarea, select {
        font-family: inherit;
        }
        /* Add this to your <style> block */
        #profile-button {
            background: hsl(var(--card));
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            position: fixed;
            top: 20px;
            right: 20px;
            left: auto;
            z-index: 1001;
            transition: transform 0.2s;
        }
        #profile-button:hover {
            transform: scale(1.1);
        }
        /* Loading Spinner */
            .loading-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 40px;
                text-align: center;
            }
            .spinner {
                width: 50px;
                height: 50px;
                border: 5px solid hsl(var(--secondary));
                border-top: 5px solid hsl(var(--primary));
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 20px;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            /* --- NEW UI ELEMENTS --- */

            /* 1. Profile Completeness Bar */
            .progress-container {
                margin-bottom: 24px;
            }
            .progress-label {
                display: flex;
                justify-content: space-between;
                font-size: 0.9rem;
                color: hsl(var(--muted-foreground));
                margin-bottom: 8px;
            }
            .progress-track {
                width: 100%;
                height: 10px;
                background: hsl(var(--secondary));
                border-radius: 5px;
                overflow: hidden;
            }
            .progress-bar-fill {
                height: 100%;
                background: linear-gradient(90deg, hsl(var(--primary)), #8b5cf6); /* Purple gradient */
                width: 0%;
                transition: width 1s ease-in-out;
            }

            /* 2. Prominent Transition Button (CTA) */
            .btn-cta {
                background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); /* Blue gradient */
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: bold;
                cursor: pointer;
                width: 100%;
                margin-top: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                transition: transform 0.2s;
            }
            .btn-cta:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            }

            /* 3. Better Review Items */
            .review-item {
                background: #fff;
                border: 1px solid hsl(var(--border));
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                border-right: 4px solid hsl(var(--secondary)); /* Subtle accent */
            }
            /* History Item Styling */
            .history-card {
                background: #fff;
                border: 1px solid hsl(var(--border));
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 16px;
                transition: all 0.2s ease;
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: relative;
                overflow: hidden;
            }
            .history-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                border-color: hsl(var(--primary));
            }
            .history-card::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 6px;
                background: hsl(var(--primary));
                border-radius: 3px 0 0 3px;
            }
            .history-info h3 {
                font-size: 1.1rem;
                color: hsl(var(--foreground));
                margin-bottom: 4px;
            }
            .history-meta {
                font-size: 0.85rem;
                color: hsl(var(--muted-foreground));
                display: flex;
                gap: 15px;
            }
            .history-status {
                font-size: 0.8rem;
                padding: 4px 10px;
                border-radius: 12px;
                background: #e0f2fe;
                color: #0284c7;
                font-weight: bold;
            }
            .profile-stats {
                display: flex;
                justify-content: space-around;
                gap: 10px;
                background: hsl(var(--secondary));
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 24px;
                text-align: center;
            }
            .stat-item {
                flex: 1;
            }
            .stat-value {
                font-size: 1.5rem;
                font-weight: bold;
                color: hsl(var(--primary));
            }
            .stat-label {
                font-size: 0.8rem;
                color: hsl(var(--muted-foreground));
                margin-top: 4px;
            }
            .premium-badge {
                background: linear-gradient(135deg, #f59e0b, #d97706);
                color: white;
                padding: 2px 8px;
                border-radius: 10px;
                font-size: 0.7rem;
                font-weight: bold;
                display: inline-block;
                margin-left: 5px;
            }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <!-- Profile Button (Visible only when logged in) -->
    {% if user.is_authenticated %}
        <div id="profile-button" onclick="showProfilePanel()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        </div>
    {% endif %}

    <!-- Main Content Container -->
    <div id="mainContent" class="main-content">
        
        <!-- 1. Home Page -->
        <div id="homePage" class="page-content hidden">
            <div class="home-page">
                <div class="home-container">
                    <div class="home-title">
                        <h1>کافنا</h1>
                        <p>کشف مسیر شغلی ایده‌آل با تست استعدادیابی هوشمند</p>
                    </div>
                    <div class="home-buttons">
                        <button class="home-button" id="startPrimaryBtn" onclick="showPage('user-info')">
                            <h2>شروع تست استعدادیابی</h2>
                            <p>در کمتر از ۱۰ دقیقه، مسیر شغلی خود را کشف کنید</p>
                        </button>
                        <button class="home-button secondary" onclick="loadTestsMenu()">
                            <h2>آزمون های سطح سنجی</h2>
                            <p>سنجش سطح مهارت در حوزه های مختلف</p>
                        </button>
                        <button class="home-button" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);" onclick="showPage('subscription')">
                            <h2>خرید اشتراک ویژه</h2>
                            <p>دسترسی نامحدود به تمامی آزمون‌ها و تحلیل‌ها</p>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Login / User Info Page -->
        <div id="userInfoPage" class="page-content hidden">
            <div class="test-container" style="padding-top: 80px;">
                <!-- Explanation Text -->
                <div style="text-align: center; margin-bottom: 24px; padding: 20px; background: hsl(var(--secondary)); border-radius: 12px; line-height: 1.8;">
                    <h2 style="color: hsl(var(--primary-glow)); margin-bottom: 16px;">اپلیکیشن هوشمند کافنا</h2>
                    <p style="font-size: 1.1rem; color: #333;">
                        با اپلیکیشن هوشمند کافنا مسیر شغلیت رو خلق کن
                    </p>
                </div>
                <!-- Login Form -->
                <div class="question-card">
                    <h2 class="question-title" style="text-align: center; margin-bottom: 32px;">ورود به اپلیکیشن</h2>
                    {% csrf_token %}
                    <div style="margin-bottom: 16px;">
                        <label for="userPhone">شماره تماس(به انگلیسی) </label>
                        <input type="tel" id="userPhone" class="input-field" placeholder="مثال: 09123456789" maxlength="11" pattern="09[0-9]{9}">   
                    </div>
                    <div style="margin-bottom: 32px;">
                        <label for="regFullName">نام و نام خانوادگی</label>
                        <input type="text" id="regFullName" class="input-field" placeholder="نام کامل خود را وارد کنید...">
                    </div>
                    <button id="requestOtpBtn" class="btn btn-primary" style="width: 100%;" onclick="requestOTP()">دریافت کد تایید</button>
                </div>
            </div>
        </div>

        <!-- 3. OTP Entry Page -->
        <div id="otpPage" class="page-content hidden">
            <div class="test-container" style="padding-top: 80px;">
                <div class="question-card">
                    <h2 class="question-title" style="text-align: center; margin-bottom: 32px;">کد تایید را وارد کنید</h2>
                    <p style="text-align: center; color: hsl(var(--muted-foreground)); margin-bottom: 24px;">
                        یک کد ۶ رقمی به شماره شما ارسال شد.
                    </p>
                    <div style="margin-bottom: 32px;">
                        <label for="otpCode" style="display: block; margin-bottom: 8px;">کد تایید</label>
                        <input type="text" id="otpCode" class="input-field" placeholder="کد ۶ رقمی..." inputmode="numeric" maxlength="6">
                    </div>
                    <button id="verifyOtpBtn" class="btn btn-primary" style="width: 100%;" onclick="verifyOTP()">تایید و ورود</button>
                </div>
            </div>
        </div>

        <!-- 4. Profile Panel Page -->
        <div id="profilePage" class="page-content hidden">
            <div class="test-container" style="padding-top: 80px;">
                <div class="question-card" id="profileForm">
                    <h2 class="question-title" style="text-align: center; margin-bottom: 32px;">پروفایل شما</h2>
                    
                    <div id="profileStats" class="profile-stats">
                        <!-- JavaScript will populate this section -->
                        <div class="stat-item"><div class="stat-value">--</div><div class="stat-label">بارگذاری...</div></div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <label>شماره تماس (غیرقابل تغییر)</label>
                        <input type="text" id="profilePhone" class="input-field" readonly>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label for="profileFullName">نام و نام خانوادگی</label>
                        <input type="text" id="profileFullName" class="input-field" placeholder="نام کامل خود را وارد کنید...">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label for="profileAge">سن</label>
                        <input type="number" id="profileAge" class="input-field" placeholder="سن خود را وارد کنید...">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label for="profileAddress">آدرس (شهر)</label>
                        <input type="text" id="profileAddress" class="input-field" placeholder="شهر محل سکونت...">
                    </div>
                    <div style="margin-bottom: 32px;">
                        <label for="profileAbout">درباره من</label>
                        <textarea id="profileAbout" class="input-field" rows="4" placeholder="چند جمله درباره خودتان..."></textarea>
                    </div>

                    <div class="nav-buttons" style="justify-content: space-between;">
                        <button class="btn btn-secondary" onclick="logout()">خروج از حساب</button>
                        <button class="btn btn-secondary" style="background: hsl(var(--primary)); color: white;" onclick="loadHistory()">تاریخچه آزمون‌ها</button>
                        <button id="saveProfileBtn" class="btn btn-primary" onclick="saveProfile()">ذخیره تغییرات</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. History List Page -->
        <div id="historyPage" class="page-content hidden">
            <div class="results-container">
                <div class="results-header">
                    <h1 class="results-title">تاریخچه آزمون‌های شما</h1>
                    <p>لیست تمام ارزیابی‌هایی که تا کنون انجام داده‌اید.</p>
                </div>
                <div id="historyList" style="display: flex; flex-direction: column; gap: 16px;"></div>
                <div class="action-buttons" style="margin-top: 32px;">
                    <button class="btn btn-secondary" onclick="showProfilePanel()">بازگشت به پروفایل</button>
                </div>
            </div>
        </div>

        <!-- 6. History Review Page (ReadOnly) -->
        <div id="historyReviewPage" class="page-content hidden">
            <div class="results-container">
                <div class="results-header">
                    <h1 class="results-title">مرور پاسخ‌های ثبت شده</h1>
                    <div id="historyMeta" style="color: hsl(var(--muted-foreground)); margin-top: 8px;"></div>
                </div>
                <div id="historyReviewContent" class="results-card"></div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="showPage('history')">بازگشت به لیست</button>
                    <button id="viewAnalysisBtn" class="btn btn-primary" onclick="viewHistoryAnalysis()">مشاهده تحلیل هوش مصنوعی</button>
                </div>
            </div>
        </div>

        <!-- 7. Skills Assessment Page (The Test) -->
        <div id="skillsAssessmentPage" class="page-content hidden">
            <div class="test-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <div id="questionContainer"></div>
                <div class="nav-buttons">
                    <button class="btn btn-secondary" onclick="navigateTo('home')">انصراف</button> 
                    <div> 
                        <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()">قبلی</button>
                        <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">بعدی</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 8. Review Answers Page (Before Submit) -->
        <div id="reviewPage" class="page-content hidden">
            <div class="results-container">
                <div class="results-header">
                    <h1 class="results-title">مرور پاسخ‌ها</h1>
                    <p>لطفا پاسخ‌های خود را بررسی کنید. در صورت تایید، تحلیل هوشمند برای شما ارسال خواهد شد.</p>
                </div>
                <div id="reviewContent" class="results-card"></div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="editAnswers()">ویرایش پاسخ‌ها</button>
                    <button class="btn btn-primary" onclick="submitAnswers()">تایید و ارسال نهایی</button>
                </div>
            </div>
        </div>

        <!-- 9. Results Page (AI Output) -->
        <div id="resultsPage" class="page-content hidden">
            <div class="results-container">
                <div class="results-header">
                    <h1 class="results-title">نتایج تست استعدادیابی شما</h1>
                    <p>مسیر شغلی شخصی‌سازی شده بر اساس پاسخ‌های شما</p>
                </div>
                <div id="resultsContent"></div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="navigateTo('home')">بازگشت به خانه</button>
                    <button class="btn btn-primary" onclick="downloadResults()">دانلود نتایج</button>
                    <button class="btn btn-primary" onclick="shareResults()">اشتراک‌گذاری</button>
                    <button class="btn btn-primary" onclick="loadTestsMenu()">آزمون‌های تخصصی</button>
                </div>
            </div>
        </div>

        <!-- 10. Tests Menu Page -->
        <div id="testsMenuPage" class="page-content hidden">
            <div class="results-container">
                <div class="results-header">
                    <h1 class="results-title">آزمون‌های تخصصی</h1>
                    <p>برای سنجش دقیق‌تر، یکی از آزمون‌های زیر را انتخاب کنید.</p>
                </div>
                <div id="testsGrid" style="display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));"></div>
                <div class="action-buttons" style="margin-top: 32px;">
                    <button class="btn btn-secondary" onclick="showPage('home')">بازگشت</button>
                </div>
            </div>
        </div>

        <!-- 11. About Page -->
        <div id="aboutPage" class="page-content hidden">
            <div class="container">
                <h1 style="font-size: 2.5rem; margin-bottom: 32px;">درباره ما</h1>
                <div class="question-card">
                    <p>کافنا یک پلتفرم هوشمند استعدادیابی شغلی است که به افراد کمک می‌کند تا مسیر حرفه‌ای ایده‌آل خود را کشف کنند.</p>
                </div>
            </div>
        </div>

        <!-- 12. Contact Page -->
        <div id="contactPage" class="page-content hidden">
            <div class="container">
                <h1 style="font-size: 2.5rem; margin-bottom: 32px;">تماس با ما</h1>
                <div class="question-card">
                    <p>برای پشتیبانی و اطلاعات بیشتر می‌توانید از طریق ایمیل زیر با ما در ارتباط باشید:</p>
                    <p style="font-weight: 600; margin-top: 16px;">support@kafna.ir</p>
                </div>
            </div>
        </div>

        <!-- 13. subscription plans-->
        <div id="subscriptionPage" class="page-content hidden">
            <div class="results-container" style="max-width: 900px;">
                <div class="results-header">
                    <h1 class="results-title" style="color: #d97706;">ارتقا به نسخه حرفه‌ای</h1>
                    <p>برای دسترسی به آزمون‌های تخصصی و نقشه‌ی راه دقیق، اشتراک تهیه کنید.</p>
                </div>

                <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin-top: 40px;">
                    <!-- Free Plan -->
                    <div class="question-card" style="flex: 1; min-width: 300px; border: 1px solid #ddd; opacity: 0.8;">
                        <h3>نسخه رایگان</h3>
                        <div style="font-size: 2rem; font-weight: bold; margin: 20px 0;">۰ تومان</div>
                        <ul style="list-style: none; line-height: 2;">
                            <li>✅ تست استعدادیابی اولیه</li>
                            <li>✅ مشاهده ۳ شغل پیشنهادی</li>
                            <li>❌ آزمون‌های سطح‌سنجی تخصصی</li>
                            <li>❌ نقشه راه ۶ ماهه</li>
                        </ul>
                        <button class="btn btn-secondary" style="width: 100%; margin-top: 20px;" onclick="showPage('home')">بازگشت</button>
                    </div>

                    <!-- Pro Plan -->
                    <div class="question-card" style="flex: 1; min-width: 300px; border: 2px solid hsl(var(--primary)); transform: scale(1.05); box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                        <div style="background: hsl(var(--primary)); color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; position: absolute; top: -12px; left: 50%; transform: translateX(-50%);">پیشنهاد ویژه</div>
                        <h3 style="color: hsl(var(--primary));">نسخه حرفه‌ای</h3>
                        <div style="font-size: 2rem; font-weight: bold; margin: 20px 0;">۹۹,۰۰۰ تومان</div>
                        <ul style="list-style: none; line-height: 2;">
                            <li>✅ تست استعدادیابی اولیه</li>
                            <li>✅ مشاهده ۳ شغل پیشنهادی</li>
                            <li>✅ <b>دسترسی نامحدود</b> به تمام آزمون‌های تخصصی</li>
                            <li>✅ دریافت <b>نقشه راه دقیق</b> و منابع یادگیری</li>
                        </ul>
                        <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="buySubscription()">خرید اشتراک</button>
                    </div>
                    <div style="max-width: 400px; margin: 40px auto; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 12px;">
                        <h3 style="margin-bottom: 16px; font-size: 1.1rem;">کد تخفیف یا کد سازمانی دارید؟</h3>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="promoCodeInput" class="input-field" placeholder="کد را اینجا وارد کنید..." style="text-align: center;">
                            <button class="btn btn-primary" onclick="redeemCode()">ثبت</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- End of mainContent -->

    <!-- SCRIPTS START HERE -->
    <!-- (Your existing script block goes here) -->
</body>

<script>
/* ==========================================================================
   1. GLOBAL UTILITIES (Defined at top to fix ReferenceError)
   ========================================================================== */
function linkEnterToNext(inputId, nextId) {
    const i = document.getElementById(inputId);
    const n = document.getElementById(nextId);
    if (i && n) {
        i.addEventListener('keyup', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                // If next is input, focus; if button, click
                if (n.tagName === 'INPUT' || n.tagName === 'TEXTAREA') n.focus();
                else n.click();
            }
        });
    }
}

function downloadResults() {
    const element = document.getElementById('resultsContent');
    html2canvas(element, { 
        scale: 2, 
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff'
    }).then(canvas => {
        const { jsPDF } = window.jspdf;
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const pageHeight = 297;
        let imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;

        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }

        pdf.save('نتایج تست.pdf');
    }).catch(err => {
        console.error('PDF generation failed:', err);
        alert('خطا در دانلود. لطفا دوباره تلاش کنید.');
    });
}

/* ==========================================================================
   2. GLOBAL STATE
   ========================================================================== */
console.log("Script Initialized");
let currentQuestion = 0;
let answers = {};
let questions = [];
let currentTestId = null;
let currentTestName = '';
let historyDataCache = [];
let currentHistoryItem = null;

/* ==========================================================================
   3. NAVIGATION
   ========================================================================== */
function showPage(page, updateHistory = true) {
    console.log("Navigating to:", page);
    document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));

    const id = {
        home: 'homePage', 'user-info': 'userInfoPage',
        'skills-assessment': 'skillsAssessmentPage',
        results: 'resultsPage', otp: 'otpPage',
        profile: 'profilePage', review: 'reviewPage',
        'tests-menu': 'testsMenuPage', history: 'historyPage',
        'history-review': 'historyReviewPage',
        'subscription': 'subscriptionPage' 
    }[page];

    const el = document.getElementById(id);
    if (el) el.classList.remove('hidden');
    else { console.error("CRITICAL ERROR: Page element not found for ID:", id); return; }

    const profileBtn = document.getElementById('profile-button');
    if (profileBtn) {
        profileBtn.style.display = (page === 'home' || page === 'profile') ? 'flex' : 'none';
    }

    if (updateHistory) history.pushState({ page: page }, '', `#${page}`);
}

function navigateTo(page) { showPage(page); }

window.onpopstate = function(event) {
    if (event.state && event.state.page) showPage(event.state.page, false);
    else showPage('{{ initial_page|default:"user-info" }}', false);
};

/* ==========================================================================
   4. AUTHENTICATION
   ========================================================================== */
function requestOTP() {
    const phone = document.getElementById('userPhone').value.trim();
    const fullName = document.getElementById('regFullName').value.trim();
    if (!phone || !fullName) { alert('لطفا تمام فیلدها را پر کنید.'); return; }
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch('/api/request-otp/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ phone_number: phone })
    }).then(r => r.json()).then(data => {
        if (data.status === 'success') {
            showPage('otp');
            setTimeout(() => document.getElementById('otpCode').focus(), 100);
        } else { alert('خطا: ' + data.message); }
    });
}

function verifyOTP() {
    const phone = document.getElementById('userPhone').value.trim();
    const code = document.getElementById('otpCode').value.trim();
    const fullName = document.getElementById('regFullName').value.trim();
    if (!code || code.length !== 6) { alert('لطفا کد ۶ رقمی را به درستی وارد کنید.'); return; }
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch('/api/verify-otp/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ phone_number: phone, code: code, full_name: fullName })
    }).then(r => r.json()).then(data => {
        if (data.status === 'success') window.location.href = '/';
        else alert('خطا: ' + data.message);
    });
}

function logout() {
    if (confirm("آیا برای خروج از حساب کاربری خود اطمینان دارید؟\n\nتوجه: برای ورود مجدد، باید نام و شماره تماس خود را مجدداً وارد کنید.")) {
        window.location.href = '/logout/';
    }
}

function showProfilePanel() {
    const profilePage = document.getElementById('profilePage');
    if (!profilePage.classList.contains('hidden')) { showPage('home'); return; }

    const statsContainer = document.getElementById('profileStats');
    if(statsContainer) {
        statsContainer.innerHTML = `<div class="stat-item"><div class="stat-value">--</div><div class="stat-label">در حال بارگذاری...</div></div>`;
    }

    showPage('profile');

    const profilePromise = fetch('/api/profile/').then(r => r.json());
    const rankPromise = fetch('/api/user-rank/').then(r => r.json());

    Promise.all([profilePromise, rankPromise])
        .then(([profileData, rankData]) => {
            // 1. Populate the form fields (no change here)
            if (profileData.status === 'success') {
                const p = profileData.profile;
                document.getElementById('profilePhone').value = p.phone_number;
                document.getElementById('profileFullName').value = p.full_name;
                document.getElementById('profileAge').value = p.age;
                document.getElementById('profileAddress').value = p.address;
                document.getElementById('profileAbout').value = p.about_me;
            }

            // 2. THE FIX: Populate the stats section WITHOUT the rank.
            if (rankData.status === 'success' && statsContainer) {
                const isPremium = {{ user.is_premium|yesno:"true,false" }};
                // Determine the text and badge for premium status
                const premiumStatusText = isPremium ? 'ویژه' : 'رایگان';
                const premiumBadge = isPremium ? '<span class="premium-badge">Premium</span>' : '';

                statsContainer.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-value">${rankData.assessment_count}</div>
                        <div class="stat-label">آزمون تکمیل شده</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${premiumStatusText} ${premiumBadge}</div>
                        <div class="stat-label">وضعیت حساب</div>
                    </div>
                `;
            }

            // 3. Setup the form's "Save" button and "Enter" key logic (no change here)
            const saveBtn = document.getElementById('saveProfileBtn');
            saveBtn.disabled = true; saveBtn.style.opacity = '0.5';
            const form = document.getElementById('profileForm');
            form.addEventListener('input', () => {
                saveBtn.disabled = false; saveBtn.style.opacity = '1'; saveBtn.style.cursor = 'pointer';
            }, { once: true });
            
            // ... (your existing Enter key logic can remain) ...
        })
        .catch(err => {
            console.error("Error loading profile data:", err);
            if (statsContainer) {
                statsContainer.innerHTML = `<div class="stat-item"><div class="stat-label" style="color:red;">خطا در بارگذاری</div></div>`;
            }
        });
}

function saveProfile() {
    const data = {
        full_name: document.getElementById('profileFullName').value,
        age: document.getElementById('profileAge').value,
        address: document.getElementById('profileAddress').value,
        about_me: document.getElementById('profileAbout').value,
    };
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch('/api/profile/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify(data)
    }).then(r => r.json()).then(d => {
        if (d.status === 'success') { alert('پروفایل ذخیره شد.'); showPage('home'); }
        else { alert('خطا در ذخیره.'); }
    });
}

function redeemCode() {
    const code = document.getElementById('promoCodeInput').value;
    if (!code) return;
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch('/api/redeem-code/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
        body: JSON.stringify({ code: code })
    }).then(r => r.json()).then(data => {
        if (data.status === 'success') { alert("تبریک! حساب شما ارتقا یافت."); window.location.reload(); }
        else { alert(data.message); }
    });
}

/* ==========================================================================
   5. TESTS & EXECUTION
   ========================================================================== */
function loadTestsMenu() {
    showPage('tests-menu');
    const container = document.getElementById('testsGrid');
    container.innerHTML = '<div class="loading-container"><div class="spinner"></div></div>';

    fetch('/api/tests/list/')
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success' && data.tests.length > 0) {
                container.innerHTML = data.tests.map(test => `
                    <div class="question-card" style="cursor: pointer; transition: transform 0.2s; height: 100%; display: flex; flex-direction: column; justify-content: space-between;" 
                         onmouseover="this.style.transform='scale(1.02)'" 
                         onmouseout="this.style.transform='scale(1)'"
                         onclick="startSpecificTest(${test.id}, '${test.name}')">
                        <div>
                            <h3 style="color: hsl(var(--primary)); margin-bottom: 8px;">${test.name}</h3>
                            <p style="color: hsl(var(--muted-foreground)); font-size: 0.9rem; line-height: 1.6;">${test.description || 'سنجش تخصصی مهارت‌ها'}</p>
                        </div>
                        <button class="btn btn-primary" style="width: 100%; margin-top: 16px;">شروع آزمون</button>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div class="question-card" style="grid-column: 1/-1; text-align: center;"><p>فعلاً آزمون تخصصی دیگری موجود نیست.</p></div>';
            }
        })
        .catch(err => {
            console.error(err);
            container.innerHTML = '<p style="color: red;">خطا در بارگذاری آزمون‌ها.</p>';
        });
}

function startSpecificTest(testId, testName = 'آزمون') {
    const startTestId = "{{ start_test_id|default:'' }}"; 
    const isPremium = "{{ user.is_premium|yesno:'true,false' }}" === "true"; 
    if (testId.toString() !== startTestId && !isPremium) {
        showPage('subscription'); return;
    }
    currentTestId = testId;
    currentTestName = testName;
    answers = {};
    const saved = localStorage.getItem(`draft_answers_${testId}`);
    if (saved) { try { answers = JSON.parse(saved); } catch(e) { answers = {}; } }
    loadQuestions(testId);
    showPage('skills-assessment');
}

function loadQuestions(testId) {
    currentQuestion = 0;
    console.log("Fetching questions for Test ID:", testId);
    fetch(`/api/tests/${testId}/questions/`).then(r => r.json()).then(data => {
        console.log("Questions API Response:", data);
        questions = data;
        if (questions.length > 0) {
            showPage('skills-assessment');
            renderQuestion();
        } else { document.getElementById('questionContainer').innerHTML = '<p>سوالی یافت نشد.</p>'; }
    }).catch(err => console.error(err));
}

// --- RENDER ---
function renderQuestion() {
    const q = questions[currentQuestion];
    const container = document.getElementById('questionContainer');
    if (!container) return;
    const progress = ((currentQuestion + 1) / questions.length) * 100;
    document.getElementById('progressBar').style.width = `${progress}%`;

    let html = `<div class="question-card">
        <p style="color:hsl(var(--muted-foreground));margin-bottom:8px;">سوال ${currentQuestion + 1} از ${questions.length}</p>
        <h2 class="question-title">${q.question}</h2>`;

    if (q.type === 'multiple') {
        html += '<div>';
        q.options.forEach(opt => {
            const sel = answers[q.id] === opt ? 'selected' : '';
            const esc = opt.replace(/'/g, "\\'");
            html += `<button class="option-button ${sel}" onclick="selectOption(${q.id}, '${esc}')">${opt}</button>`;
        });
        html += '</div>';
    } else if (q.type === 'slider') {
        const val = answers[q.id] ?? 5;
        html += `<div class="slider-container"><input type="range" class="slider" min="${q.min}" max="${q.max}" value="${val}" oninput="updateSlider(${q.id}, this)"><div style="display:flex;justify-content:space-between;font-weight:600;margin-top:8px;"><span>${q.min}</span><span id="sliderValue-${q.id}">${val}</span><span>${q.max}</span></div><div style="display:flex;justify-content:space-between;font-size:.85rem;padding:0 4px;"><span>مخالفم</span><span>موافقم</span></div></div>`;
    } else if (q.type === 'text') {
        const val = answers[q.id] ?? '';
        html += `<input type="text" id="textAnswerInput" class="input-field" value="${val}" oninput="updateText(${q.id}, this.value)" placeholder="...">`;
    }
    html += '</div>';
    container.innerHTML = html;

    // Auto-focus text input
    if (q.type === 'text') {
        setTimeout(() => document.getElementById('textAnswerInput').focus(), 100);
    }

    if (q.type === 'slider') updateSliderFill(container.querySelector('.slider'));

    document.onkeyup = null;
    if (q.type === 'text') linkEnterToNext('textAnswerInput', 'nextBtn');
    else {
        document.onkeyup = function(event) {
            if (event.key === 'Enter') { event.preventDefault(); document.getElementById('nextBtn').click(); }
        };
    }
    document.getElementById('prevBtn').disabled = currentQuestion === 0;
    document.getElementById('nextBtn').textContent = currentQuestion === questions.length - 1 ? 'مشاهده نتایج' : 'بعدی';
}

function selectOption(id, opt) { answers[id] = opt; saveProgress(); renderQuestion(); }
function updateSlider(id, el) {
    const val = parseInt(el.value);
    answers[id] = val;
    document.getElementById(`sliderValue-${id}`).textContent = val;
    updateSliderFill(el);
    saveProgress();
}
function updateSliderFill(el) {
    const pct = ((el.value - el.min) / (el.max - el.min)) * 100;
    el.style.setProperty('--track-fill', `${pct}%`);
}
function updateText(id, val) { answers[id] = val.trim(); saveProgress(); }
function saveProgress() { if (currentTestId) localStorage.setItem(`draft_answers_${currentTestId}`, JSON.stringify(answers)); }

function nextQuestion() {
    const q = questions[currentQuestion];
    const ans = answers[q.id];
    if (ans === undefined || ans === '') { alert("لطفا پاسخ دهید."); return; }
    if (currentQuestion < questions.length - 1) { currentQuestion++; renderQuestion(); }
    else { showReviewPage(); }
}
function previousQuestion() { if (currentQuestion > 0) { currentQuestion--; renderQuestion(); } }

function showReviewPage() {
    showPage('review');
    const container = document.getElementById('reviewContent');
    container.innerHTML = questions.map(q => `
        <div class="review-item">
            <p style="font-size:1rem;font-weight:500;margin-bottom:8px;">${q.question}</p>
            <div style="background:hsl(var(--secondary));padding:10px;border-radius:8px;color:hsl(var(--primary));">${answers[q.id] || '---'}</div>
        </div>`).join('');
}
function editAnswers() { showPage('skills-assessment'); }

/* ==========================================================================
   6. SUBMIT & RESULTS (Two-Step with Retry)
   ========================================================================== */
function submitAnswers(retryCount = 0) {
    showPage('results');
    const resultsContainer = document.getElementById('resultsContent');
    
    // Updated Loading Messages (stays longer, stops at final)
    const messages = [
        "در حال ارسال پاسخ‌ها...", 
        "هوش مصنوعی در حال تحلیل...", 
        "بررسی انطباق شغلی...", 
        "تدوین نقشه راه..."
    ];
    let msgIndex = 0;
    resultsContainer.innerHTML = `
        <div class="loading-container">
            <div class="spinner"></div>
            <h3 id="loadingText" style="color:hsl(var(--primary));margin-bottom:10px;">${messages[0]}</h3>
            <p>لطفاً شکیبا باشید</p>
        </div>`;
    
    // CHANGED: 4000ms (4 seconds) instead of 2500ms, and stops at last message
    const loadingInterval = setInterval(() => {
        msgIndex++;
        if (msgIndex < messages.length) {
            const el = document.getElementById('loadingText');
            if(el) el.textContent = messages[msgIndex];
        } else {
            // Stop at the last message - don't loop back
            clearInterval(loadingInterval);
        }
    }, 4000); // Changed from 2500 to 4000ms

    const submissionData = { user_info: {}, responses: [] };
    questions.forEach(q => {
        if (answers[q.id] !== undefined) {
            submissionData.responses.push({ question_id: q.id, question_text: q.question, answer: answers[q.id] });
        }
    });

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Step 1: Save Draft
    fetch(`/api/tests/${currentTestId}/save-draft/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify(submissionData)
    })
    .then(r => r.json())
    .then(draftData => {
        if (draftData.status !== 'success') throw new Error("خطا در ذخیره پاسخ‌ها");
        localStorage.removeItem(`draft_answers_${currentTestId}`);
        return performAnalysis(currentTestId, draftData.result_id, submissionData, retryCount, loadingInterval);
    })
    .catch(err => {
        clearInterval(loadingInterval);
        console.error(err);
        resultsContainer.innerHTML = `<p style="color:red;text-align:center;">${err.message}</p><button class="btn btn-primary" onclick="submitAnswers()">تلاش مجدد</button>`;
    });
}

function performAnalysis(testId, resultId, submissionData, retryCount, intervalId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const resultsContainer = document.getElementById('resultsContent');

    fetch(`/api/tests/${testId}/analyze/${resultId}/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken }
    })
    .then(r => r.json())
    .then(data => {
        clearInterval(intervalId);
        if (data.status === 'success') {
            showResults(submissionData, data.analysis);
        } else {
            throw new Error(data.message || "خطا در تحلیل");
        }
    })
    .catch(err => {
        if (retryCount < 2) {
            setTimeout(() => performAnalysis(testId, resultId, submissionData, retryCount + 1, intervalId), 2000);
        } else {
            clearInterval(intervalId);
            resultsContainer.innerHTML = `
                <div class="results-card" style="text-align: center;">
                    <h3 style="color: orange;">تحلیل انجام نشد</h3>
                    <p>پاسخ‌های شما ذخیره شد اما ارتباط با هوش مصنوعی برقرار نشد.</p>
                    <p style="font-size: 0.9rem; color: gray;">${err.message}</p>
                    <button class="btn btn-primary" onclick="performAnalysis(${testId}, ${resultId}, null, 0)">تلاش مجدد</button>
                    <button class="btn btn-secondary" style="margin-top:10px;" onclick="showPage('home')">بازگشت به خانه</button>
                </div>`;
        }
    });
}

function showResults(userData, analysis) {
    const container = document.getElementById('resultsContent');
    if (!container) return;

    const userName = "{{ user.full_name|default:'کاربر' }}";
    const title = currentTestName || "نتیجه آزمون";
    document.querySelector('#resultsPage .results-header h1').textContent = `نتیجه: ${title}`;
    document.querySelector('#resultsPage .results-header p').textContent = `${userName} عزیز، تحلیل اختصاصی شما آماده است.`;

    let html = '';

    if (!analysis) {
        html = '<div class="results-card"><p>اطلاعات موجود نیست.</p></div>';
    } else if (typeof analysis === 'string') {
        html = `<div class="results-card"><p>${analysis}</p></div>`;
    } else {
        // 1. MBTI / General (Gradient Card)
        if (analysis.mbti || analysis.analysis) {
            html += `
            <div class="results-card" style="background: linear-gradient(135deg, hsl(var(--secondary)) 0%, #fff 100%); border: 1px solid hsl(var(--primary));">
                <h2 style="color: hsl(var(--primary)); margin-bottom: 16px;">تحلیل کلی</h2>
                ${analysis.mbti ? `
                    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
                        <h3 style="font-size: 2rem; color: hsl(var(--foreground));">${analysis.mbti.type || ''}</h3>
                        <span style="background:hsl(var(--primary)); color:white; padding:4px 12px; border-radius:20px; font-size:0.8rem;">${analysis.dominant_domain || 'General'}</span>
                    </div>
                    <p style="color: hsl(var(--muted-foreground)); margin-top:10px; line-height:1.7;">${analysis.mbti.description || ''}</p>
                ` : `<p style="line-height:1.7;">${analysis.analysis}</p>`}
            </div>`;
        }

        // 2. Recommended Jobs (With CTA Buttons)
        if (analysis.recommended_jobs && analysis.recommended_jobs.length > 0) {
            html += `
            <div class="results-card">
                <h2 style="color: hsl(var(--primary)); margin-bottom: 24px;">شغل‌های پیشنهادی</h2>
                ${analysis.recommended_jobs.map((career, index) => `
                    <div class="career-item" style="margin-bottom: 16px; padding: 20px; border: 1px solid hsl(var(--border)); border-radius: 12px; position: relative; overflow: hidden;">
                        ${index === 0 ? '<div style="position:absolute; top:0; left:0; background:hsl(var(--primary)); color:white; padding:4px 12px; font-size:0.7rem; border-bottom-right-radius:12px;">پیشنهاد اصلی</div>' : ''}
                        
                        <div class="career-title" style="font-weight: bold; font-size: 1.2rem; color: #263b80; margin-top:10px;">${career.job}</div>
                        <p style="color: hsl(var(--foreground)); margin-bottom: 16px; font-size: 0.95rem;">${career.reason}</p>
                        
                        ${career.test_id ? `
                            <button class="btn btn-primary" style="width:100%; display:flex; justify-content:center; align-items:center; gap:8px;" 
                                    onclick="startSpecificTest(${career.test_id}, '${career.job}')">
                                <span>سنجش سطح تخصصی این مهارت</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                            </button>
                        ` : ''}
                    </div>
                `).join('')}
            </div>`;
        }

        // 3. Development Path (Fancy List)
        const devPath = analysis.development_path || analysis.development_points;
        if (devPath && devPath.length > 0) {
            html += `
            <div class="results-card">
                <h2 style="color: hsl(var(--primary)); margin-bottom: 16px;">مسیر رشد و یادگیری</h2>
                <ul style="list-style-type: none; padding: 0;">
                    ${devPath.map(step => `
                        <li style="margin-bottom: 12px; padding: 16px; background: #fff; border-radius: 8px; border-right: 4px solid hsl(var(--primary)); box-shadow: 0 2px 8px rgba(0,0,0,0.05); display:flex; align-items:center;">
                            <span style="color:hsl(var(--primary)); font-size:1.2rem; margin-left:10px;">•</span>
                            ${step}
                        </li>
                    `).join('')}
                </ul>
            </div>`;
        }
    }
    container.innerHTML = html;
}

/* ==========================================================================
   7. HISTORY
   ========================================================================== */
function loadHistory() {
    showPage('history');
    const container = document.getElementById('historyList');
    container.innerHTML = '<div class="loading-container"><div class="spinner"></div></div>';

    fetch('/api/history/')
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success' && data.history.length > 0) {
                historyDataCache = data.history;
                container.innerHTML = data.history.map((item, index) => {
                    const hasAnalysis = item.analysis && Object.keys(item.analysis).length > 0;
                    const statusBadge = hasAnalysis 
                        ? '<span style="font-size:0.8rem; padding:4px 10px; border-radius:12px; background:#dcfce7; color:#166534;">تکمیل شده</span>' 
                        : '<span style="font-size:0.8rem; padding:4px 10px; border-radius:12px; background:#fff7ed; color:#9a3412;">در انتظار تحلیل</span>';

                    return `
                    <div class="question-card" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-right: 4px solid hsl(var(--primary));" 
                         onclick="openHistoryItem(${index})">
                        <div>
                            <h3 style="font-size: 1.1rem; color: hsl(var(--primary)); margin-bottom: 4px;">${item.test_name}</h3>
                            <div style="font-size: 0.85rem; color: hsl(var(--muted-foreground));">
                                <span>📅 ${item.date}</span> | <span>⏰ ${item.time}</span>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;">
                            ${statusBadge}
                            <button class="btn btn-secondary" style="font-size: 0.85rem; padding: 6px 12px;">مشاهده</button>
                        </div>
                    </div>`;
                }).join('');
            } else {
                container.innerHTML = '<div class="question-card" style="text-align:center;"><p>هنوز آزمونی ثبت نکرده‌اید.</p></div>';
            }
        })
        .catch(err => {
            console.error(err);
            container.innerHTML = '<p style="color:red; text-align:center;">خطا در دریافت تاریخچه.</p>';
        });
}

function openHistoryItem(index) {
    const item = historyDataCache[index];
    if (!item) return;
    currentHistoryItem = item; // Save to global variable

    showPage('history-review');
    document.getElementById('historyMeta').textContent = `آزمون: ${item.test_name} | تاریخ: ${item.date}`;
    
    // Render Answers
    const responses = item.answers.responses || [];
    document.getElementById('historyReviewContent').innerHTML = responses.map(r => `
        <div class="review-item">
            <p style="font-weight:500; margin-bottom:5px;">${r.question_text}</p>
            <div style="background:hsl(var(--secondary)); padding:8px; border-radius:6px; color:hsl(var(--primary));">
                ${r.answer}
            </div>
        </div>`).join('') || '<p>جزئیات موجود نیست.</p>';

    // THE FIX: Handle the Analysis Button
    const btn = document.getElementById('viewAnalysisBtn');
    
    if (item.analysis) {
        btn.style.display = 'inline-block';
        btn.textContent = "مشاهده تحلیل هوش مصنوعی";
        
        // DIRECTLY ASSIGN THE FUNCTION HERE
        btn.onclick = function() {
            // 1. Switch Page
            showPage('results');
            // 2. Render Data
            showResults(item.answers, item.analysis);
            
            // 3. Fix Back Button behavior for History context
            const backBtn = document.querySelector('#resultsPage .action-buttons .btn-secondary');
            if(backBtn) {
                backBtn.onclick = function() { showPage('history-review'); };
                backBtn.textContent = "بازگشت به مرور";
            }
        };
    } else {
        btn.style.display = 'none';
    }
}

/* ==========================================================================
   8. INIT
   ========================================================================== */
document.addEventListener('DOMContentLoaded', () => {
    const initialPage = '{{ initial_page|default:"user-info" }}';
    const isAuthenticated = {{ is_authenticated|yesno:"true,false" }};
    const startTestId = "{{ start_test_id|default:'' }}";

    // Smart Refresh
    let targetPage = initialPage;
    if (isAuthenticated) {
        const hash = window.location.hash.substring(1);
        if (hash && ['home','profile','history','tests-menu','skills-assessment'].includes(hash)) targetPage = hash;
    }
    showPage(targetPage, false);

    // Resume Test Logic
    if (targetPage === 'skills-assessment' && isAuthenticated) {
        const activeId = localStorage.getItem('active_test_id');
        if (activeId) loadQuestions(activeId);
        else if (startTestId) startSpecificTest(startTestId, 'استعدادیابی');
        else showPage('home');
    }

    // Primary Button Logic
    if (isAuthenticated && startTestId) {
        const btn = document.getElementById('startPrimaryBtn');
        if (btn) btn.onclick = () => startSpecificTest(startTestId, 'استعدادیابی');
    }

    linkEnterToNext('regFullName', 'userPhone');
    linkEnterToNext('userPhone', 'requestOtpBtn');
    linkEnterToNext('otpCode', 'verifyOtpBtn');
    setTimeout(() => document.getElementById('userPhone').focus(), 100);
});
</script>
</body>
</html>