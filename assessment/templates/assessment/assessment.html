<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>کافنا - تست استعدادیابی هوشمند</title>
    <meta name="description" content="با تست استعدادیابی شغلی هوش مصنوعی Loveble، مسیر حرفه‌ای شخصی‌سازی‌شده و برنامه عملیاتی ۱۸۰ روزه دریافت کنید. مورد اعتماد بیش از ۱۸,۰۰۰ کاربر.">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: 263 80% 55%;
            --primary-glow: 280 85% 65%;
            --background: 0 0% 100%;
            --foreground: 0 0% 10%;
            --secondary: 263 25% 95%;
            --secondary-foreground: 263 70% 40%;
            --muted: 263 15% 96%;
            --muted-foreground: 0 0% 50%;
            --border: 263 20% 90%;
            --card: 0 0% 100%;
            --card-foreground: 0 0% 10%;
        }

        body {
            font-family: 'Vazir', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: hsl(var(--background));
            color: hsl(var(--foreground));
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }


        /* Home Page */
        .home-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background:  linear-gradient(135deg, hsl(var(--background)) 0%, hsl(263, 30%, 98%) 100%);
        }

        .home-container {
            max-width: 1000px;
            width: 100%;
            padding: 20px;
        }

        .home-title {
            text-align: center;
            margin-bottom: 60px;
        }

        .home-title h1 {
            font-size: 3.5rem;
            color: hsl(var(--primary));
            margin-bottom: 16px;
        }

        .home-title p {
            font-size: 1.25rem;
            color: hsl(var(--muted-foreground));
        }

        .home-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .home-button {
            background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary-glow)) 100%);
            border: none;
            border-radius: 16px;
            padding: 40px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            text-align: right;
            position: relative;
            overflow: hidden;
        }

        .home-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 40px hsla(var(--primary), 0.3);
        }

        .home-button.secondary {
            background: linear-gradient(135deg, hsl(var(--secondary)) 0%, hsl(var(--muted)) 100%);
        }

        .home-button-icon {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            margin-right: auto;
        }

        .home-button.secondary .home-button-icon {
            background: hsla(var(--primary), 0.1);
        }

        .home-button h2 {
            font-size: 1.75rem;
            color: white;
            margin-bottom: 8px;
        }

        .home-button.secondary h2 {
            color: hsl(var(--foreground));
        }

        .home-button p {
            color: rgba(255,255,255,0.9);
            font-size: 0.95rem;
        }

        .home-button.secondary p {
            color: hsl(var(--muted-foreground));
        }

        /* Test Flow */
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .progress-bar {
            background: hsl(var(--secondary));
            height: 8px;
            border-radius: 4px;
            margin-bottom: 40px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, hsl(var(--primary)) 0%, hsl(var(--primary-glow)) 100%);
            height: 100%;
            transition: width 0.3s ease;
        }

        .question-card {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .question-title {
            font-size: 1.5rem;
            margin-bottom: 24px;
            color: hsl(var(--foreground));
        }

        .option-button {
            width: 100%;
            padding: 16px;
            margin-bottom: 12px;
            border: 2px solid hsl(var(--border));
            background: hsl(var(--background));
            border-radius: 8px;
            cursor: pointer;
            text-align: right;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .option-button:hover {
            border-color: hsl(var(--primary));
            background: hsl(var(--secondary));
        }

        .option-button.selected {
            border-color: hsl(var(--primary));
            background: hsl(var(--secondary));
            font-weight: 600;
        }

        .slider-container {
            margin: 24px 0;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: hsl(var(--secondary));
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: hsl(var(--primary));
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: hsl(var(--primary));
            cursor: pointer;
            border: none;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid hsl(var(--border));
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            margin-top: 32px;
        }

        .btn {
            padding: 12px 32px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--primary-glow)) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px hsla(var(--primary), 0.3);
        }

        .btn-secondary {
            background: hsl(var(--secondary));
            color: hsl(var(--foreground));
        }

        .btn-secondary:hover {
            background: hsl(var(--muted));
        }

        /* Results Page */
        .results-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .results-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .results-title {
            font-size: 2.5rem;
            color: hsl(var(--primary));
            margin-bottom: 16px;
        }

        .results-card {
            background: hsl(var(--card));
            border: 1px solid hsl(var(--border));
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
        }

        .career-item {
            padding: 16px;
            background: hsl(var(--secondary));
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .career-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: hsl(var(--primary));
            margin-bottom: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 32px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .home-title h1 {
                font-size: 2rem;
            }

            .home-buttons {
                grid-template-columns: 1fr;
            }
        }
        .slider {
        /* --track-fill is a variable we will control with JavaScript */
        background: linear-gradient(to left, hsl(var(--primary)) 0%, hsl(var(--primary)) var(--track-fill, 50%), hsl(var(--secondary)) var(--track-fill, 50%), hsl(var(--secondary)) 100%);
        }
        button, input, textarea, select {
        font-family: inherit;
        }
        /* Add this to your <style> block */
        #profile-button {
            background: hsl(var(--card));
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            position: fixed;
            top: 20px;
            right: 20px;
            left: auto;
            z-index: 1001;
            transition: transform 0.2s;
        }
        #profile-button:hover {
            transform: scale(1.1);
        }
        .spinner {
            border: 4px solid hsla(var(--primary), 0.1);
            border-left-color: hsl(var(--primary));
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-container {
            text-align: center;
            padding: 40px;
            color: hsl(var(--foreground));
        }
    </style>
</head>
<body>
    {% if user.is_authenticated %}
        <div id="profile-button" onclick="showProfilePanel()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        </div>
    {% endif %}
    <!-- Main Content -->
    <div id="mainContent">
        <!-- Home Page -->
        <div id="homePage" class="page-content hidden">
            <div class="home-page">
                <div class="home-container">
                    <div class="home-title">
                        <h1>کافنا</h1>
                        <p>کشف مسیر شغلی ایده‌آل با تست استعدادیابی هوشمند</p>
                    </div>
                    <div class="home-buttons">
                        <button class="home-button" id="startPrimaryBtn" onclick="showPage('user-info')">
                            <h2>شروع تست استعدادیابی</h2>
                            <p>در کمتر از ۱۰ دقیقه، مسیر شغلی خود را کشف کنید</p>
                        </button>
                        <button class="home-button secondary" onclick="loadTestsMenu()">
                            <h2>آزمون های سطح سنجی</h2>
                            <p>سنجش سطح مهارت در حوزه های مختلف</p>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="otpPage" class="page-content hidden">
            <div class="test-container" style="padding-top: 80px;">
                <div class="question-card">
                    <h2 class="question-title" style="text-align: center; margin-bottom: 32px;">کد تایید را وارد کنید</h2>
                    <p style="text-align: center; color: hsl(var(--muted-foreground)); margin-bottom: 24px;">
                        یک کد ۶ رقمی به شماره شما ارسال شد.
                    </p>
                    <div style="margin-bottom: 32px;">
                        <label for="otpCode" style="display: block; margin-bottom: 8px;">کد تایید</label>
                        <input type="text" id="otpCode" class="input-field" placeholder="کد ۶ رقمی..." inputmode="numeric" maxlength="6">
                    </div>
                    <button id="verifyOtpBtn" class="btn btn-primary" style="width: 100%;" onclick="verifyOTP()">تایید و ورود</button>
                </div>
            </div>
        </div>

                <!-- NEW: The Profile Panel Page -->
        <div id="profilePage" class="page-content hidden">
        <div class="test-container" style="padding-top: 80px;">
            <div class="question-card" id="profileForm">
                <h2 class="question-title" style="text-align: center; margin-bottom: 32px;">پروفایل شما</h2>
                
                <div style="margin-bottom: 16px;">
                    <label>شماره تماس (غیرقابل تغییر)</label>
                    <input type="text" id="profilePhone" class="input-field" readonly>
                </div>
                <div style="margin-bottom: 16px;">
                    <label for="profileFullName">نام و نام خانوادگی</label>
                    <input type="text" id="profileFullName" class="input-field" placeholder="نام کامل خود را وارد کنید...">
                </div>
                <div style="margin-bottom: 16px;">
                    <label for="profileAge">سن</label>
                    <input type="number" id="profileAge" class="input-field" placeholder="سن خود را وارد کنید...">
                </div>
                <div style="margin-bottom: 16px;">
                    <label for="profileAddress">آدرس (شهر)</label>
                    <input type="text" id="profileAddress" class="input-field" placeholder="شهر محل سکونت...">
                </div>
                <div style="margin-bottom: 32px;">
                    <label for="profileAbout">درباره من</label>
                    <textarea id="profileAbout" class="input-field" rows="4" placeholder="چند جمله درباره خودتان..."></textarea>
                </div>

                <div class="nav-buttons" style="justify-content: space-between;">
                    <button class="btn btn-secondary" onclick="logout()">خروج از حساب</button>

                    <button id="saveProfileBtn" class="btn btn-primary" onclick="saveProfile()">ذخیره تغییرات</button>
                </div>
            </div>
        </div>
    </div>

        <!-- Replace the entire userInfoPage div with this corrected version -->
        <div id="userInfoPage" class="page-content hidden">
            <div class="test-container" style="padding-top: 80px;">
                
                <!-- 1. The explanation text is now OUTSIDE the form card -->
                <div style="text-align: center; margin-bottom: 24px; padding: 20px; background: hsl(var(--secondary)); border-radius: 12px; line-height: 1.8;">
                    <h2 style="color: hsl(var(--primary-glow)); margin-bottom: 16px;">اپلیکیشن هوشمند کافنا</h2>
                    <p style="font-size: 1.1rem; color: #333;">
                        با اپلیکیشن هوشمند کافنا مسیر شغلیت رو خلق کن
                    </p>
                </div>

                <!-- 2. The form card is now a single, clean element -->
                <div class="question-card">
                    <h2 class="question-title" style="text-align: center; margin-bottom: 32px;">ورود به اپلیکیشن</h2>
                    {% csrf_token %}
                    <div style="margin-bottom: 16px;">
                        <label for="userPhone">شماره تماس</label>
                        <input type="tel" id="userPhone" class="input-field" placeholder="مثال: 09123456789" maxlength="11" pattern="09[0-9]{9}">   
                    </div>
                    <div style="margin-bottom: 32px;">
                        <label for="regFullName">نام و نام خانوادگی</label>
                        <input type="text" id="regFullName" class="input-field" placeholder="نام کامل خود را وارد کنید...">
                    </div>
                    <button id="requestOtpBtn" class="btn btn-primary" style="width: 100%;" onclick="requestOTP()">دریافت کد تایید</button>
                </div>

    </div>
</div>

        <!-- Skills Assessment Page -->
        <div id="skillsAssessmentPage" class="page-content hidden">
            <div class="test-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
                <div id="questionContainer"></div>
                <div class="nav-buttons">
                    <!-- ADD THIS NEW BUTTON -->
                    <button class="btn btn-secondary" onclick="navigateTo('home')">انصراف</button> 
                    <div> <!-- Wrap the existing buttons in a div for better layout -->
                        <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()">قبلی</button>
                        <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">بعدی</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- review page-->
        <div id="reviewPage" class="page-content hidden">
            <div class="results-container">
                <div class="results-header">
                    <h1 class="results-title">مرور پاسخ‌ها</h1>
                    <p>لطفا پاسخ‌های خود را بررسی کنید. در صورت تایید، تحلیل هوشمند برای شما ارسال خواهد شد.</p>
                </div>
                <div id="reviewContent" class="results-card"></div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="editAnswers()">ویرایش پاسخ‌ها</button>
                    <button class="btn btn-primary" onclick="submitAnswers()">تایید و ارسال نهایی</button>
                </div>
            </div>
        </div>

        <!-- Results Page -->
        <div id="resultsPage" class="page-content hidden">
            <div class="results-container">
                <div class="results-header">
                    <h1 class="results-title">نتایج تست استعدادیابی شما</h1>
                    <p>مسیر شغلی شخصی‌سازی شده بر اساس پاسخ‌های شما</p>
                </div>
                <div id="resultsContent"></div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="navigateTo('home')">بازگشت به خانه</button>
                    <button class="btn btn-primary" onclick="downloadResults()">دانلود نتایج</button>
                    <button class="btn btn-primary" onclick="shareResults()">اشتراک‌گذاری</button>
                    <button class="btn btn-primary" onclick="loadTestsMenu()">آزمون‌های تخصصی</button>
                </div>
            </div>
        </div>

    </div>

    <div id="aboutPage" class="page-content hidden">
        <div class="container">
            <h1 style="font-size: 2.5rem; margin-bottom: 32px;">درباره ما</h1>
            <div class="question-card">
                <!-- ADD THIS CONTENT -->
                <p>کافنا یک پلتفرم هوشمند استعدادیابی شغلی است که به افراد کمک می‌کند تا مسیر حرفه‌ای ایده‌آل خود را کشف کنند. ما با استفاده از تحلیل‌های پیشرفته، به کاربران کمک می‌کنیم تا نقاط قوت خود را بشناسند و یک برنامه عملی برای رسیدن به اهداف شغلی خود تدوین کنند.</p>
            </div>
        </div>
    </div>

    <div id="testsMenuPage" class="page-content hidden">
        <div class="results-container">
            <div class="results-header">
                <h1 class="results-title">آزمون‌های تخصصی</h1>
                <p>برای سنجش دقیق‌تر، یکی از آزمون‌های زیر را انتخاب کنید.</p>
            </div>
            
            <!-- This grid will be filled by JavaScript -->
            <div id="testsGrid" style="display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                <!-- Tests will appear here -->
            </div>

            <div class="action-buttons" style="margin-top: 32px;">
                <button class="btn btn-secondary" onclick="showPage('home')">بازگشت</button>
            </div>
        </div>
    </div>

    <!-- In your contactPage div -->
    <div id="contactPage" class="page-content hidden">
        <div class="container">
            <h1 style="font-size: 2.5rem; margin-bottom: 32px;">تماس با ما</h1>
            <div class="question-card">
                <!-- ADD THIS CONTENT -->
                <p>برای پشتیبانی و اطلاعات بیشتر می‌توانید از طریق ایمیل زیر با ما در ارتباط باشید:</p>
                <p style="font-weight: 600; margin-top: 16px;">support@kafna.ir</p>
            </div>
        </div>
    </div>


<script>
/* -------------------------------------------------
   STATE
   ------------------------------------------------- */
let currentQuestion = null;
let answers       = {};
let questions     = [];
// NEW: Track the ID of the test currently being taken
let currentTestId = null; 

/* -------------------------------------------------
   PAGE NAVIGATION
   ------------------------------------------------- */
function showPage(page, updateHistory = true) {
    document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
    const id = {
        home: 'homePage', 'user-info': 'userInfoPage',
        'skills-assessment': 'skillsAssessmentPage',
        results: 'resultsPage', otp: 'otpPage', profile: 'profilePage', review: 'reviewPage',
        'tests-menu': 'testsMenuPage'
    }[page];
    const el = document.getElementById(id);
    if (el) el.classList.remove('hidden');
    else { console.error('Page not found:', page); return; }
    
    updateProfileButtonVisibility(page);

    if (updateHistory) {
        history.pushState({ page: page }, '', `#${page}`);
    }
}

function navigateTo(page) { showPage(page); }

window.onpopstate = function(event) {
    if (event.state && event.state.page) {
        showPage(event.state.page, false);
    } else {
        showPage('{{ initial_page|default:"user-info" }}', false);
    }
};

/* -------------------------------------------------
   UI HELPERS
   ------------------------------------------------- */
function updateProfileButtonVisibility(page) {
    const profileButton = document.getElementById('profile-button');
    if (!profileButton) return;
    if (page === 'home' || page === 'profile') {
        profileButton.style.display = 'flex';
    } else {
        profileButton.style.display = 'none';
    }
}

/* -------------------------------------------------
   OTP / LOGIN FLOW
   ------------------------------------------------- */
function requestOTP() {
    const phone = document.getElementById('userPhone').value.trim();
    const fullName = document.getElementById('regFullName').value.trim();
    if (!phone || !fullName) { alert('لطفا تمام فیلدها را پر کنید.'); return; }
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch('/api/request-otp/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ phone_number: phone })
    }).then(r => r.json()).then(data => {
        if (data.status === 'success') showPage('otp');
        else alert('خطا: ' + data.message);
    });
}

function verifyOTP() {
    const phone = document.getElementById('userPhone').value.trim();
    const code = document.getElementById('otpCode').value.trim();
    const fullName = document.getElementById('regFullName').value.trim();
    if (!code || code.length !== 6) { alert('لطفا کد ۶ رقمی را به درستی وارد کنید.'); return; }
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch('/api/verify-otp/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ phone_number: phone, code: code, full_name: fullName })
    }).then(r => r.json()).then(data => {
        if (data.status === 'success') window.location.href = '/';
        else alert('خطا: ' + data.message);
    });
}

/* -------------------------------------------------
   PROFILE PANEL
   ------------------------------------------------- */
function showProfilePanel() {
    const profilePage = document.getElementById('profilePage');
    if (!profilePage.classList.contains('hidden')) { showPage('home'); return; }
    fetch('/api/profile/').then(r => r.json()).then(data => {
        if (data.status === 'success') {
            const profile = data.profile;
            document.getElementById('profilePhone').value = profile.phone_number;
            document.getElementById('profileFullName').value = profile.full_name;
            document.getElementById('profileAge').value = profile.age;
            document.getElementById('profileAddress').value = profile.address;
            document.getElementById('profileAbout').value = profile.about_me;
            
            const saveBtn = document.getElementById('saveProfileBtn');
            saveBtn.disabled = true; saveBtn.style.opacity = '0.5'; saveBtn.style.cursor = 'not-allowed';
            const form = document.getElementById('profileForm');
            const enableButton = () => {
                saveBtn.disabled = false; saveBtn.style.opacity = '1'; saveBtn.style.cursor = 'pointer';
                form.removeEventListener('input', enableButton);
            };
            form.addEventListener('input', enableButton);
            
            // Enter key logic for profile
            linkEnterToNext('profileFullName', 'profileAge');
            linkEnterToNext('profileAge', 'profileAddress');
            linkEnterToNext('profileAddress', 'profileAbout');
            linkEnterToNext('profileAbout', 'saveProfileBtn');

            showPage('profile');
        } else { alert('خطا در بارگذاری پروفایل.'); }
    });
}

function saveProfile() {
    const profileData = {
        full_name: document.getElementById('profileFullName').value,
        age: document.getElementById('profileAge').value,
        address: document.getElementById('profileAddress').value,
        about_me: document.getElementById('profileAbout').value,
    };
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch('/api/profile/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify(profileData)
    }).then(r => r.json()).then(data => {
        if (data.status === 'success') { alert('پروفایل شما با موفقیت ذخیره شد.'); showPage('home'); }
        else { alert('خطا در ذخیره پروفایل.'); }
    });
}

function logout() {
    const confirmationMessage = "آیا برای خروج از حساب کاربری خود اطمینان دارید؟\n\nتوجه: برای ورود مجدد، باید نام و شماره تماس خود را مجدداً وارد کنید.";
    if (confirm(confirmationMessage)) { window.location.href = '/logout/'; }
}

/* -------------------------------------------------
   ASSESSMENT LOGIC (UPDATED for New Architecture)
   ------------------------------------------------- */
function loadQuestions(testId = null) {
    // If a testID is passed, update the global currentTestId
    if (testId) {
        currentTestId = testId;
    }

    if (!currentTestId) {
        console.error("No test ID found to load.");
        return;
    }

    currentQuestion = 0;
    // THE FIX: Use the new URL structure with the Test ID
    fetch(`/api/tests/${currentTestId}/questions/`)
        .then(r => r.json())
        .then(data => {
            questions = data;
            if (questions.length) renderQuestion();
            else document.getElementById('questionContainer').innerHTML = '<p>سوالی برای نمایش وجود ندارد.</p>';
            }
        )
        .catch(err => {
            console.error(err);
            document.getElementById('questionContainer').innerHTML = '<p style="color:red;">خطا در بارگذاری سوالات.</p>';
        });
}

function submitAnswers(retryCount = 0) {
    // Safety check: Ensure we know which test we are submitting
    if (!currentTestId) {
        alert("خطا: شناسه آزمون یافت نشد. لطفا صفحه را رفرش کنید.");
        return;
    }

    showPage('results');
    const resultsContainer = document.getElementById('resultsContent');
    
    resultsContainer.innerHTML = `
        <div class="loading-container">
            <div class="spinner"></div>
            <h3 style="margin-bottom: 10px;">در حال تحلیل هوشمند پاسخ‌ها...</h3>
            <p style="color: hsl(var(--muted-foreground));">لطفاً شکیبا باشید، هوش مصنوعی در حال بررسی دقیق پروفایل شماست.</p>
            ${retryCount > 0 ? `<p style="font-size: 0.9rem; color: orange;">تلاش مجدد (${retryCount}/3)...</p>` : ''}
        </div>
    `;

    const submissionData = {
        user_name: answers.user_name,
        user_phone: answers.user_phone
    };
    
    questions.forEach(q => {
        if (answers[q.id] !== undefined) {
            submissionData[q.id] = answers[q.id];
        }
    });

    const csrfTokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfTokenInput) {
        resultsContainer.innerHTML = '<p style="color: red; text-align: center;">خطای امنیتی: توکن یافت نشد. لطفاً صفحه را رفرش کنید.</p>';
        return;
    }

    // --- THE FIX IS HERE ---
    // We must use backticks (`) to insert the currentTestId variable
    fetch(`/api/tests/${currentTestId}/submit/`, { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfTokenInput.value
        },
        body: JSON.stringify(submissionData)
    })
    .then(r => {
        if (!r.ok) { throw new Error(`Server Error: ${r.status}`); }
        return r.json();
    })
    .then(data => {
        if (data.status === 'success') {
            showResults(submissionData, data.analysis);
        } else {
            throw new Error(data.message || "خطا در پردازش");
        }
    })
    .catch(err => {
        console.error("Attempt failed:", err);
        
        if (retryCount < 3) {
            setTimeout(() => submitAnswers(retryCount + 1), 2000);
        } else {
            resultsContainer.innerHTML = `
                <div class="results-card" style="text-align: center;">
                    <h3 style="color: red; margin-bottom: 16px;">خطا در دریافت تحلیل</h3>
                    <p>متاسفانه ارتباط با هوش مصنوعی برقرار نشد.</p>
                    <p style="font-size: 0.9rem; color: gray; margin-bottom: 20px;">${err.message}</p>
                    <button class="btn btn-primary" onclick="submitAnswers()">تلاش دستی مجدد</button>
                </div>
            `;
        }
    });
}

function renderQuestion() {
    const q = questions[currentQuestion];
    const container = document.getElementById('questionContainer');
    if (!container) return;
    const progress = ((currentQuestion + 1) / questions.length) * 100;
    document.getElementById('progressBar').style.width = `${progress}%`;
    
    let html = `<div class="question-card"><p style="color:hsl(var(--muted-foreground));margin-bottom:8px;">سوال ${currentQuestion + 1} از ${questions.length}</p><h2 class="question-title">${q.question}</h2>`;
    
    if (q.type === 'multiple') {
        html += '<div>';
        q.options.forEach(opt => {
            const sel = answers[q.id] === opt ? 'selected' : '';
            const esc = opt.replace(/'/g, "\\'");
            html += `<button class="option-button ${sel}" onclick="selectOption(${q.id}, '${esc}')">${opt}</button>`;
        });
        html += '</div>';
    } else if (q.type === 'slider') {
        const val = answers[q.id] ?? 5;
        html += `<div class="slider-container"><input type="range" class="slider" min="${q.min}" max="${q.max}" value="${val}" oninput="updateSlider(${q.id}, this)"><div style="display:flex;justify-content:space-between;margin-top:8px;font-weight:600;"><span>${q.min}</span><span id="sliderValue-${q.id}">${val}</span><span>${q.max}</span></div><div style="display:flex;justify-content:space-between;font-size:.85rem;color:hsl(var(--muted-foreground));padding:0 4px;"><span>کاملا مخالفم</span><span>کاملا موافقم</span></div></div>`;
    } else if (q.type === 'text') {
        const val = answers[q.id] ?? '';
        // Added oninput back for real-time updates
        html += `<input type="text" id="textAnswerInput" class="input-field" value="${val}" oninput="updateText(${q.id}, this.value)" placeholder="پاسخ خود را بنویسید...">`;
    }
    html += '</div>';
    container.innerHTML = html;
    
    if (q.type === 'slider') {
        const slider = container.querySelector('.slider');
        updateSliderFill(slider);
    }
    
    // --- KEYBOARD LISTENERS (Enter Key) ---
    // Clear previous listeners specifically for questions
    document.onkeyup = null; 

    if (q.type === 'text') {
        // For text, we link the input to the Next button
        linkEnterToNext('textAnswerInput', 'nextBtn');
    } else {
        // For sliders/multiple choice, global enter clicks Next
        document.onkeyup = function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                document.getElementById('nextBtn').click();
            }
        };
    }

    document.getElementById('prevBtn').disabled = currentQuestion === 0;
    document.getElementById('nextBtn').textContent = currentQuestion === questions.length - 1 ? 'مشاهده نتایج' : 'بعدی';
}
function loadTestsMenu() {
    showPage('tests-menu');
    const container = document.getElementById('testsGrid');
    container.innerHTML = '<p>در حال بارگذاری...</p>';

    fetch('/api/tests/list/')
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success' && data.tests.length > 0) {
                container.innerHTML = data.tests.map(test => `
                    <div class="question-card" style="cursor: pointer; transition: transform 0.2s;" 
                         onclick="startSpecificTest(${test.id})">
                        <h3 style="color: hsl(var(--primary)); margin-bottom: 8px;">${test.name}</h3>
                        <p style="color: hsl(var(--muted-foreground)); font-size: 0.9rem;">${test.description || ''}</p>
                        <button class="btn btn-primary" style="width: 100%; margin-top: 16px;">شروع آزمون</button>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p>فعلاً آزمون تخصصی دیگری موجود نیست.</p>';
            }
        });
}

function startSpecificTest(testId) {
    answers = {}; // Clear previous answers
    loadQuestions(testId); // Load the specific test
    showPage('skills-assessment');
}
/* -------------------------------------------------
   ANSWER HANDLERS & HELPERS
   ------------------------------------------------- */
function selectOption(id, opt) { answers[id] = opt; renderQuestion(); }
function updateSlider(id, el) {
    const val = parseInt(el.value, 10);
    answers[id] = val;
    document.getElementById(`sliderValue-${id}`).textContent = val;
    updateSliderFill(el);
}
function updateSliderFill(el) {
    if (!el) return;
    const min = +el.min, max = +el.max, val = +el.value;
    const pct = ((val - min) / (max - min)) * 100;
    el.style.setProperty('--track-fill', `${pct}%`);
}
function updateText(id, val) { answers[id] = val.trim(); }

function nextQuestion() {
    const currentQ = questions[currentQuestion];
    const currentAnswer = answers[currentQ.id];
    
    if (currentAnswer === undefined || currentAnswer === '') {
        alert("لطفا قبل از ادامه به این سوال پاسخ دهید.");
        return;
    }

    if (currentQuestion < questions.length - 1) {
        currentQuestion++;
        renderQuestion();
    } else {
        showReviewPage();
    }
}
function previousQuestion() { if (currentQuestion > 0) { currentQuestion--; renderQuestion(); } }

function showReviewPage() {
    showPage('review');
    const container = document.getElementById('reviewContent');
    if (!container) return;
    let html = '';
    questions.forEach(q => {
        const answer = answers[q.id];
        const answerText = answer !== undefined ? answer : 'پاسخ داده نشده';
        html += `<div style="margin-bottom: 20px; border-bottom: 1px solid hsl(var(--border)); padding-bottom: 16px;"><p style="font-size: 1.1rem; color: hsl(var(--foreground)); margin-bottom: 8px;">${q.question}</p><p style="font-size: 1rem; font-weight: 600; color: hsl(var(--primary)); background: hsl(var(--secondary)); padding: 8px 12px; border-radius: 6px;">${answerText}</p></div>`;
    });
    container.innerHTML = html;
}
function editAnswers() { showPage('skills-assessment'); }

function showResults(userData, analysis) {
    const container = document.getElementById('resultsContent');
    if (!container) return;

    const userName = "{{ user.full_name|default:'کاربر مهمان' }}";
    document.querySelector('#resultsPage .results-header p').textContent = 
        `${userName} عزیز، تحلیل اختصاصی شما آماده است.`;

    // SAFE GUARDS: Ensure arrays exist to prevent "map of undefined" error
    const jobs = analysis.recommended_jobs || [];
    const devPath = analysis.development_path || analysis.development_points || []; 
    const mbti = analysis.mbti || { type: "نامشخص", description: "اطلاعات کافی نیست" };
    const domain = analysis.dominant_domain || "نامشخص";
    const skills = analysis.skills_analysis || "تحلیل مهارت در دسترس نیست";

    let html = `
        <!-- 1. MBTI & Domain (New Section) -->
        <div class="results-card" style="background: linear-gradient(135deg, hsl(var(--secondary)) 0%, #fff 100%);">
            <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: center;">
                <div style="flex: 1; min-width: 200px;">
                    <h2 style="color: hsl(var(--primary)); font-size: 2rem; margin-bottom: 8px;">${mbti.type}</h2>
                    <p style="color: hsl(var(--foreground)); font-weight: 600;">${domain}</p>
                </div>
                <div style="flex: 2; min-width: 280px; border-right: 2px solid hsl(var(--border)); padding-right: 20px;">
                    <p style="color: hsl(var(--muted-foreground)); line-height: 1.7;">${mbti.description}</p>
                </div>
            </div>
        </div>

        <!-- 2. Skills Analysis -->
        <div class="results-card">
            <h2 style="color: hsl(var(--primary)); margin-bottom: 16px;">تحلیل مهارت‌ها</h2>
            <p style="line-height: 1.8;">${skills}</p>
        </div>

        <!-- 3. Recommended Jobs (With Dynamic Buttons) -->
        <div class="results-card">
            <h2 style="color: hsl(var(--primary)); margin-bottom: 24px;">شغل‌های پیشنهادی</h2>
            ${jobs.map((career, index) => `
                <div class="career-item" style="margin-bottom: 16px; padding: 20px; border: 1px solid hsl(var(--border)); border-radius: 12px; background: ${index === 0 ? 'hsl(var(--secondary))' : 'white'};">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div class="career-title" style="font-weight: bold; font-size: 1.1rem; color: #263b80;">${career.job}</div>
                        ${index === 0 ? '<span style="background:#263b80; color:white; padding:2px 10px; border-radius:12px; font-size:0.8rem;">پیشنهاد اصلی</span>' : ''}
                    </div>
                    <p style="color: hsl(var(--foreground)); margin-bottom: 12px;">${career.reason}</p>
                    
                    ${career.test_id ? `
                        <button class="btn btn-primary" style="font-size: 0.9rem; padding: 8px 16px;" 
                                onclick="startSpecificTest(${career.test_id})">
                            سنجش سطح تخصصی
                        </button>
                    ` : ''}
                </div>
            `).join('') || '<p>شغلی یافت نشد.</p>'}
        </div>

        <!-- 4. Development Path -->
        <div class="results-card">
            <h2 style="color: hsl(var(--primary)); margin-bottom: 16px;">مسیر رشد و یادگیری</h2>
            <ul style="list-style-type: none; padding: 0;">
                ${devPath.map(step => `
                    <li style="margin-bottom: 12px; padding: 12px; background: #fff; border-radius: 8px; border-right: 4px solid hsl(var(--primary)); box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        ${step}
                    </li>
                `).join('') || '<p>اطلاعات مسیر رشد موجود نیست.</p>'}
            </ul>
        </div>
    `;

    container.innerHTML = html;
}

function linkEnterToNext(currentInputId, nextElementId) {
    const currentInput = document.getElementById(currentInputId);
    const nextElement = document.getElementById(nextElementId);
    if (!currentInput || !nextElement) return;
    currentInput.addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            if (nextElement.tagName === 'INPUT' || nextElement.tagName === 'TEXTAREA') { nextElement.focus(); } 
            else { nextElement.click(); }
        }
    });
}

function setupEnterKey(inputId, buttonId) {
    const input = document.getElementById(inputId);
    const button = document.getElementById(buttonId);
    if (!input || !button) return;
    input.addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            button.click();
        }
    });
}

/* -------------------------------------------------
   INITIALISE
   ------------------------------------------------- */
document.addEventListener('DOMContentLoaded', () => {
    const initialPage = '{{ initial_page|default:"user-info" }}';
    const isAuthenticated = {{ is_authenticated|yesno:"true,false" }};
    // This gets the ID of the primary test from the backend
    const startTestId = "{{ start_test_id|default:'' }}"; 

    // 1. Show the correct page on load
    showPage(initialPage, false);
    history.replaceState({ page: initialPage }, '', `#${initialPage}`);

    // 2. If logged in, update the "Start Assessment" button
    if (isAuthenticated && startTestId) {
        const startBtn = document.getElementById('startPrimaryBtn');
        if (startBtn) {
            // Update the button to start the specific primary test
            startBtn.setAttribute('onclick', `startSpecificTest(${startTestId})`);
        }
    }

    // 3. Setup Enter Keys
    setupEnterKey('regFullName', 'requestOtpBtn');
    setupEnterKey('userPhone', 'requestOtpBtn');
    setupEnterKey('otpCode', 'verifyOtpBtn');
});

function downloadResults() { alert('این قابلیت در حال توسعه است.'); }
function shareResults() { alert('این قابلیت در حال توسعه است.'); }
</script>
</body>
</html>